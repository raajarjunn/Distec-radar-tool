{# apps/templates/technology/detail.html #}
{% extends "layouts/base.html" %}
{% load perm_tags %}
{% load static %}

{% block title %}Technology · {{ object.name }}{% endblock title %}

{% block stylesheets %}

<style>
  /* Header breadcrumb chip: dark text on white over black header */
  .header.bg-darker .crumb-light{
    background:#fff; padding:.35rem .75rem; border-radius:.5rem; display:inline-flex;
  }
  .header.bg-darker .crumb-light .breadcrumb-item,
  .header.bg-darker .crumb-light .breadcrumb-item a,
  .header.bg-darker .crumb-light .breadcrumb-item i{ color:#111 !important; }
  .header.bg-darker .crumb-light .breadcrumb-item + .breadcrumb-item::before{
    color:#111 !important; opacity:.85;
  }

  /* Chips / meta tags */
  .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;font-size:.8rem;border:1px solid rgba(0,0,0,.08);background:#fff;}
  .chip .dot{width:.45rem;height:.45rem;border-radius:50%;background:#5e72e4;}
  .chip-slate{background:#f8f9fe;border-color:#edf2f9;}
  .meta-list{display:flex;flex-wrap:wrap;gap:.5rem .75rem;}
  .meta-item{font-size:.9rem;color:#525f7f;}

  /* Section cards (light glass) */
  .section-card{
    border:1px solid rgba(255,255,255,0.25);
    box-shadow:0 8px 24px rgba(0,0,0,.10);
    border-radius:.9rem;
    background:rgba(255,255,255,.9);
    backdrop-filter:saturate(120%) blur(6px);
    -webkit-backdrop-filter:saturate(120%) blur(6px);
  }
  .section-card .card-header{ background:transparent; }
  .section-title{ font-weight:800; font-size:1.1rem; letter-spacing:.2px; display:flex; align-items:center; gap:.5rem; color:#111; }
  .section-title .ni{ font-size:1.05rem; opacity:.95; }

  /* Opaque meta box (NOT transparent) */
  .meta-box{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:.65rem;
    padding:.75rem 1rem;
  }

  .section-icon {
  width: 50px; height: 50px;
  
}


  /* Gallery */
  .gallery-grid{ display:grid; grid-template-columns:repeat(12,1fr); grid-gap:.75rem; }
  @media (max-width:992px){ .gallery-grid{grid-template-columns:repeat(8,1fr);} }
  @media (max-width:768px){ .gallery-grid{grid-template-columns:repeat(6,1fr);} }
  @media (max-width:576px){ .gallery-grid{grid-template-columns:repeat(4,1fr);} }
  .gallery-cell{ grid-column:span 3; }
  @media (max-width:1200px){ .gallery-cell{grid-column:span 4;} }
  @media (max-width:992px){  .gallery-cell{grid-column:span 6;} }
  @media (max-width:576px){  .gallery-cell{grid-column:1 / -1;} }

  .gallery-card.card{ border:1px solid rgba(0,0,0,.05); box-shadow:0 1px 8px rgba(0,0,0,.05); transition:transform .15s ease, box-shadow .15s ease; }
  .gallery-card.card:hover{ transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.08); }
  .gallery-thumb{ height:150px; width:100%; object-fit:cover; border-top-left-radius:.5rem; border-top-right-radius:.5rem; background:#f6f9fc; }
  .tag-badge{ position:absolute; top:.5rem; left:.5rem; padding:.25rem .45rem; background:rgba(255,255,255,.9); border-radius:.35rem; font-size:.75rem; font-weight:600; border:1px solid rgba(0,0,0,.08); }
  .tag-badge[data-tag="SC1"]{ color:#0d6efd; border-color:rgba(13,110,253,.35); }
  .tag-badge[data-tag="SC2"]{ color:#198754; border-color:rgba(25,135,84,.35); }

  /* --- Fix gallery overlays hiding under images/cards --- */

  /* Don't clip overlays */
  .gallery-cell,
  .gallery-card { overflow: visible; }

  /* Make the tag badge always render above the image */
  .gallery-card .tag-badge {
    position: absolute;      /* you already have this, keeping for clarity */
    z-index: 2;              /* higher than the image */
    pointer-events: none;    /* optional: badge doesn't block clicks */
  }

  /* Ensure the image sits "under" overlays */
  .gallery-card .gallery-thumb {
    position: relative;
    z-index: 0;
  }

  /* Ensure dropdown menus float above neighboring cards */
  .gallery-card .dropdown-menu {
    z-index: 2000;           /* > bootstrap cards/shadows */
  }

  /* When a card is hovered, raise it slightly in stacking order too */
  .gallery-card.card:hover {
    z-index: 3;
  }


  /* Hints */
  .empty-hint{ border:1px dashed #ced4da; padding:.75rem; border-radius:.5rem; background:#fbfdff; }
  .helper-hint{ margin-top:.75rem; padding:.6rem .75rem; border-radius:.5rem; background:#f8f9fe; border:1px solid #edf2f9; font-size:.9rem; }
  .helper-hint .badge{ vertical-align:middle; }

  /* Buttons – colorful & theme-consistent */
  .btn-toolbar .btn + .btn{ margin-left:.25rem; }
   

    /* Quick Facts card polish */
  /* Quick Facts – clean, no dark strip/shadow */
  .qf-card{
    border:1px solid rgba(0,0,0,.08);
    border-radius:12px;
    box-shadow:none;           /* no outer shadow */
  }
  .qf-header{
    background:#fff;
    border-bottom:1px solid rgba(0,0,0,.06);
    padding:.75rem 1rem;
    position:static;           /* no accent bar */
  }
  .qf-header::before{display:none;} /* kill left dark bar */
  .qf-title{margin:0; font-weight:800; letter-spacing:.2px; color:#111827;}

  /* Icon with no background “badge” */
  .qf-icon{
    display:inline-flex; align-items:center; justify-content:center;
    margin-right:.5rem; width:auto; height:auto;
    background:transparent; border:0; border-radius:0;
    color:#0d6efd;        /* subtle blue icon only */
  }

  .qf-body{padding:1rem;}

  /* Soft callout for the scorecard note */
  .qf-callout{
    background:#f5f7ff; border:1px solid #dbe4ff; border-left:4px solid #0d6efd;
    border-radius:.5rem; padding:.65rem .75rem; margin-bottom:.85rem;
  }
  .qf-callout .ni{opacity:.85; margin-right:.5rem;}

  /* Notes list + highlight first note (kept) */
  #tech-notes .d-flex.align-items-start.mb-1 .flex-grow-1{
    background:#f8f9fa; border:1px solid #e6eaf1; border-radius:.5rem;
  }
  #tech-notes .d-flex.align-items-start.mb-1:first-child .flex-grow-1{
    background:#e9f2ff; border-color:#b6d4fe; box-shadow:0 0 0 2px rgba(13,110,253,.12) inset;
  }
  #tech-notes .btn-outline-danger{border-color:#dc3545; color:#dc3545;}
  #tech-notes .btn-outline-danger:hover{background:#dc3545; color:#fff;}
  #tech-notes .note{background:#f8f9fa;border:1px solid #e6eaf1;border-radius:.5rem;padding:.75rem}
  #tech-notes .note:first-child{background:#e9f2ff;border-color:#b6d4fe;box-shadow:0 0 0 2px rgba(13,110,253,.12) inset}
  #tech-notes .note-text{white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere}
  #tech-notes .note-footer{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-top:.35rem}
  #tech-notes .note-footer .sep{opacity:.5}
  #tech-notes .note-footer form{display:inline}
  #tech-notes .note-footer .btn-link{padding:0;line-height:1}
  
</style>
{% endblock stylesheets %}

{% block content %}

<!-- Header (black) -->
<div class="header bg-darker pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col">
          <h6 class="h2 text-white d-inline-block mb-0">Technology</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links mb-0 crumb-light">
              <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i></a></li>
              <li class="breadcrumb-item"><a href="{% url 'technology_list' %}">Technologies</a></li>
              <li class="breadcrumb-item active" aria-current="page">{{ object.name }}</li>
            </ol>
          </nav>
        </div>
        <div class="col-auto"></div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt--6">
  <!-- Top summary -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-start">
          <div>
            <h3 class="mb-1">
              <span class="text-muted">Technology Name:</span> {{ object.name }}
            </h3>
            <div class="mt-2 meta-list">
              <span class="chip chip-slate"><span class="dot"></span> <strong class="ml-1">Macro:</strong>&nbsp;{{ object.macro|default:"—" }}</span>
              <span class="chip chip-slate"><span class="dot"></span> <strong class="ml-1">Meso1:</strong>&nbsp;{{ object.meso1|default:"—" }}</span>
              <span class="chip chip-slate"><span class="dot"></span> <strong class="ml-1">Meso2:</strong>&nbsp;{{ object.meso2|default:"—" }}</span>
            </div>
          </div>

          <div class="btn-toolbar">
            <div class="btn-group">
              {% if user|can:"edit_technology" %}
                <a href="{% url 'technology_update' object.pk %}" class="btn btn-sm btn-outline-primary">
                  <i class="ni ni-settings-gear-65"></i> Edit
                </a>
              {% endif %}

              {% if user|can:"delete_technology" %}
                <a href="#" class="btn btn-sm btn-danger js-open-delete"
                   data-url="{% url 'technology_delete' object.pk %}"
                   data-name="{{ object.name|escapejs }}">
                   <i class="ni ni-fat-remove"></i> Delete
                </a>
              {% endif %}

              {% if user|can:"evaluate_technology" %}
                <a class="btn btn-sm btn-primary"
                   href="{% url 'technology_evaluate' pk=object.pk %}"
                   target="_blank" rel="noopener">
                  Open Evaluation Tool
                </a>
              {% endif %}

              {% if user|can:"scorecard_generate" %}
                <a href="{% url 'technology_scorecard' object.pk %}" target="_blank" class="btn btn-sm btn-outline-primary">
                  View Scorecard
                </a>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card-body">
          {# OPAQUE meta data box #}
          <div class="meta-box mb-3">
            <div class="meta-list">
              <div class="meta-item">
                <strong>Status:</strong>
                {% if object.is_active %}
                  <span class="badge badge-success">Active</span>
                {% else %}
                  <span class="badge badge-danger">Inactive</span>
                {% endif %}
              </div>

              <div class="meta-item">
                <strong>Confidentiality:</strong>
                {% with c=object.confidentiality %}
                  {% if c == "C1" %}
                    <span class="font-weight-bold" style="color:#70AD47;">C1 - PUBLIC</span>
                  {% elif c == "C2" %}
                    <span class="font-weight-bold" style="color:#FF8C00;">C2 - CONFIDENTIAL</span>
                  {% elif c == "C3C" %}
                    <span class="font-weight-bold" style="color:#FF0000;">C3 - STRATEGIC (CIVIL)</span>
                  {% elif c == "C3M" %}
                    <span class="font-weight-bold" style="color:#FF0000;">C3 - STRATEGIC (MILITARY)</span>
                  {% elif c|slice:":2" == "C3" %}
                    {# fallback if some old records still store plain "C3" #}
                    <span class="font-weight-bold" style="color:#FF0000;">C3 - STRATEGIC</span>
                  {% else %}
                    <span class="badge badge-secondary">{{ object.confidentiality|default:"—" }}</span>
                  {% endif %}
                {% endwith %}
              </div>


              <div class="meta-item"><strong>Created:</strong> {{ object.created_at|date:"Y-m-d H:i" }}</div>
              <div class="meta-item"><strong>Last Modified:</strong> {{ object.last_modified|date:"Y-m-d H:i" }}</div>
            </div>
          </div>

          {% if object.description %}
            <p class="text-muted mb-0">{{ object.description|linebreaksbr }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="row mt-3">
    <!-- Left column -->
    <div class="col-lg-8">

      <div class="card section-card mb-3">
        <div class="card-header py-2">
          <h4 class="section-title mb-0 d-flex align-items-center"><img src="{% static 'assets/img/icons/des.png' %}" alt="" class="section-icon mr-2">Descriptions &amp; Applications</h4>
        </div>
        <div class="card-body">
          {% if object.desc_and_applications and object.desc_and_applications|striptags|length > 0 %}
            <div class="prose">{{ object.desc_and_applications|safe }}</div>
          {% elif object.desc_and_applications and "<li" in object.desc_and_applications and object.desc_and_applications|striptags|length == 0 %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No data added.</div>
          {% else %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No content provided.</div>
          {% endif %}
          <div class="helper-hint">
            <span class="badge badge-info mr-1">Hint</span>
            Some pertinent details about the disruptive technology. State applications. Cite a baseline application; declare a reference technology.
          </div>
        </div>
      </div>

      <div class="card section-card mb-3">
        <div class="card-header py-2">
          <h4 class="section-title mb-0 d-flex align-items-center"><img src="{% static 'assets/img/icons/pub.png' %}" alt="" class="section-icon mr-2"> Publications &amp; Projects</h4>
        </div>
        <div class="card-body">
          {% if object.publications_and_projects and object.publications_and_projects|striptags|length > 0 %}
            <div class="prose">{{ object.publications_and_projects|safe }}</div>
          {% elif object.publications_and_projects and "<li" in object.publications_and_projects and object.publications_and_projects|striptags|length == 0 %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No data to view (only empty bullets found).</div>
          {% else %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No content provided.</div>
          {% endif %}
          <div class="helper-hint">
            <span class="badge badge-info mr-1">Hint</span>
            SAFRAN FdR, external publications, patents, funded projects.
          </div>
        </div>
      </div>

      <div class="card section-card mb-3">
        <div class="card-header py-2">
          <h4 class="section-title mb-0 d-flex align-items-center"><img src="{% static 'assets/img/icons/att.png' %}" alt="" class="section-icon mr-2"> Attributes &amp; Performance</h4>
        </div>
        <div class="card-body">
          {% if object.attributes_and_performance and object.attributes_and_performance|striptags|length > 0 %}
            <div class="prose">{{ object.attributes_and_performance|safe }}</div>
          {% elif object.attributes_and_performance and "<li" in object.attributes_and_performance and object.attributes_and_performance|striptags|length == 0 %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No data to view (only empty bullets found).</div>
          {% else %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No content provided.</div>
          {% endif %}
          <div class="helper-hint">
            <span class="badge badge-info mr-1">Hint</span>
            Further describe the technology and review performance outcomes.
          </div>
        </div>
      </div>

      <div class="card section-card mb-3">
        <div class="card-header py-2">
          <h4 class="section-title mb-0 d-flex align-items-center"><img src="{% static 'assets/img/icons/str.png' %}" alt="" class="section-icon mr-2"> Strategic Value &amp; Evaluation</h4>
        </div>
        <div class="card-body">
          {% if object.strategic_value_and_evaluation and object.strategic_value_and_evaluation|striptags|length > 0 %}
            <div class="prose">{{ object.strategic_value_and_evaluation|safe }}</div>
          {% elif object.strategic_value_and_evaluation and "<li" in object.strategic_value_and_evaluation and object.strategic_value_and_evaluation|striptags|length == 0 %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No data to view (only empty bullets found).</div>
          {% else %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No content provided.</div>
          {% endif %}
          <div class="helper-hint">
            <span class="badge badge-info mr-1">Hint</span>
            Highlight strategic value and discuss the evaluation chart.
          </div>
        </div>
      </div>

      <div class="card section-card mb-3">
        <div class="card-header py-2">
          <h4 class="section-title mb-0 d-flex align-items-center"><img src="{% static 'assets/img/icons/ena.png' %}" alt="" class="section-icon mr-2"> Enabling Technologies</h4>
        </div>
        <div class="card-body">
          {% if object.enabling_technologies and object.enabling_technologies|striptags|length > 0 %}
            <div class="prose">{{ object.enabling_technologies|safe }}</div>
          {% elif object.enabling_technologies and "<li" in object.enabling_technologies and object.enabling_technologies|striptags|length == 0 %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No data to view (only empty bullets found).</div>
          {% else %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No content provided.</div>
          {% endif %}
          <div class="helper-hint">
            <span class="badge badge-info mr-1">Hint</span>
            Brief review of enabling technologies crucial to this tech.
          </div>
        </div>
      </div>

      <div class="card section-card mb-3">
        <div class="card-header py-2">
          <h4 class="section-title mb-0 d-flex align-items-center"><img src="{% static 'assets/img/icons/cha.png' %}" alt="" class="section-icon mr-2">Challenges &amp; Current Status</h4>
        </div>
        <div class="card-body">
          {% if object.challenges_and_current_status and object.challenges_and_current_status|striptags|length > 0 %}
            <div class="prose">{{ object.challenges_and_current_status|safe }}</div>
          {% elif object.challenges_and_current_status and "<li" in object.challenges_and_current_status and object.challenges_and_current_status|striptags|length == 0 %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No data to view (only empty bullets found).</div>
          {% else %}
            <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No content provided.</div>
          {% endif %}
          <div class="helper-hint">
            <span class="badge badge-info mr-1">Hint</span>
            Indicate TRL/SRL, challenges, and risk mitigation strategies.
          </div>
        </div>
      </div>

      {% if extra_fields %}
      <div class="card section-card mb-3">
        <div class="card-header py-2">
          <h4 class="section-title mb-0"><i class="ni ni-bullet-list-67 text-default"></i> Additional Fields</h4>
        </div>
        <div class="card-body">
          <div class="row">
            {% for f in extra_fields %}
              <div class="col-md-6 mb-3">
                <div class="border rounded p-3 h-100 bg-white">
                  <strong class="d-block mb-2">{{ f.name }}</strong>
                  {% if f.content and f.content|striptags|length > 0 %}
                    <div class="prose">{{ f.content|safe }}</div>
                  {% elif f.content and "<li" in f.content and f.content|striptags|length == 0 %}
                    <div class="empty-hint small"><span class="badge badge-light mr-1">Info</span> No data to view (only empty bullets found).</div>
                  {% else %}
                    <div class="empty-hint small"><span class="badge badge-light mr-1">Info</span> No content provided.</div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Right column -->
    <div class="col-lg-4">
      
        <div class="card section-card mb-3" id="gallery-card">
            <div class="card-header py-2 d-flex align-items-center justify-content-between">
              <h4 class="section-title mb-0">
                <i class="ni ni-album-2 text-primary"></i> Gallery
              </h4>

              {% if user|can:"edit_technology" %}
                <div class="d-flex align-items-center">
                  <span id="gallery-save-indicator" class="badge bg-success me-2" style="display:none;">Saved ✓</span>
                  <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btn-toggle-gallery-edit">
                      Edit Gallery
                    </button>
                    <button type="button" class="btn btn-sm btn-success" id="btn-done-gallery-edit" style="display:none;">
                      Done
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" id="btn-cancel-gallery-edit" style="display:none;">
                      Cancel
                    </button>
                  </div>
                </div>
              {% endif %}
            </div>

            <div class="card-body">
              {% if user|can:"edit_technology" %}
                <!-- Upload / Dropzone (hidden until edit mode) -->
                <div class="dropzone mb-3 edit-only" id="upload-bar"
                    style="display:none"
                    data-upload-url="{% url 'technology_gallery_add' object.pk %}">
                  <input id="gallery-upload-file" type="file" accept="image/*" class="form-control" style="max-width:320px">
                  <select id="gallery-upload-tag" class="form-select" style="max-width:120px;">
                    <option value="">-- Tag --</option>
                    <option value="SC1">SC1</option>
                    <option value="SC2">SC2</option>
                  </select>
                  <button id="btn-gallery-upload" class="btn btn-success btn-sm" type="button">Upload</button>
                  <span class="text-muted small ms-2">Tip: drag & drop an image onto this bar.</span>
                </div>
              {% endif %}

              {% if gallery %}
                <div class="gallery-grid">
                  {% for img in gallery %}
                    <div class="gallery-cell">
                      <div class="card gallery-card position-relative"
                          data-image="{{ img.name }}"
                          {% if user|can:"edit_technology" %}
                            data-url-update="{% url 'technology_gallery_update_tag' object.pk %}"
                            data-url-delete="{% url 'technology_gallery_delete' object.pk %}"
                          {% endif %}>
                        {% if img.tag %}
                          <span class="tag-badge" data-tag="{{ img.tag }}">{{ img.tag }}</span>
                        {% endif %}

                        <a href="{% if img.b64 %}{{ img.b64 }}{% elif img.image_path %}{{ MEDIA_URL }}{{ img.image_path }}{% endif %}"
                          class="js-open-image"
                          data-name="{{ img.name|default:'Image' }}">
                          <img
                            loading="lazy"
                            class="card-img-top gallery-thumb"
                            src="{% if img.b64 %}{{ img.b64 }}{% elif img.image_path %}{{ MEDIA_URL }}{{ img.image_path }}{% endif %}"
                            alt="{{ img.name|default:'Image' }}"
                            title="{{ img.name|default:'Image' }}">
                        </a>

                        {% if user|can:"edit_technology" %}
                          <!-- Per-card actions (hidden until edit mode) -->
                          <div class="card-body edit-only" style="display:none">
                            <div class="d-flex align-items-center justify-content-between actions">
                              <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-white dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                  <i class="ni ni-settings-gear-65 me-1"></i> Edit
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                  <li><span class="dropdown-header">Set tag</span></li>
                                  <li><button class="dropdown-item js-quick-tag" type="button" data-tag="SC1">Tag as SC1</button></li>
                                  <li><button class="dropdown-item js-quick-tag" type="button" data-tag="SC2">Tag as SC2</button></li>
                                  <li><button class="dropdown-item js-quick-tag" type="button" data-tag="">Clear tag</button></li>
                                </ul>
                              </div>
                              <button class="btn btn-sm btn-outline-danger js-del-image" type="button">
                                <i class="ni ni-fat-remove me-1"></i> Delete
                              </button>
                            </div>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="empty-hint"><span class="badge badge-light mr-1">Info</span> No images uploaded.</div>
              {% endif %}
            </div>
      </div>

      <div class="card qf-card">
        <div class="card-header qf-header d-flex align-items-center">
          <span class="qf-icon"><i class="ni ni-single-copy-04"></i></span>
          <h4 class="qf-title mb-0">Quick Facts</h4>
        </div>

        <div class="card-body qf-body">
          <div class="qf-callout d-flex align-items-center">
            <i class="ni ni-bulb-61 mr-2"></i>
            <div><strong>Note:</strong> Only the first 6 fields will be available for the scorecard.</div>
          </div>

          <div id="tech-notes"
              hx-get="{% url 'tech_notes' object.pk %}"
              hx-trigger="revealed once, from:body"
              hx-swap="outerHTML">
            <span class="text-muted small">Loading notes…</span>
          </div>
        </div>
    </div>
  </div>


</div>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imgModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="imgModalTitle">Image</h6>
        <button type="button"
                class="close btn-close"
                data-dismiss="modal"
                data-bs-dismiss="modal"
                aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>

      </div>
      <div class="modal-body p-2">
        <img id="imgModalPic" alt="" class="img-fluid rounded w-100" style="max-height:70vh; object-fit:contain;">
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteTechModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
    <div class="modal-content">
      <form id="deleteTechForm" method="post" action="">
        {% csrf_token %}
        <div class="modal-header py-2">
          <h6 class="modal-title">Delete Technology</h6>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
        </div>
        <div class="modal-body">
          <p class="small mb-2">This action cannot be undone.</p>
          <p class="mb-2 small">Type the technology name to confirm:</p>
          <div class="mb-2"><span id="deleteConfirmTarget" class="badge badge-light p-2 text-dark"></span></div>
          <input type="text" class="form-control" id="deleteConfirmInput" name="confirm_name" placeholder="">
          <small class="text-muted">You must type the name exactly.</small>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger" id="deleteSubmitBtn" disabled>Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
{{ block.super }}

<script src="https://unpkg.com/htmx.org@1.9.12" defer></script>

<script>
/* ========= Utilities ========= */
(function(){
  function csrfValue(){
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
  }
  function showSavedBadge(){
    const b = document.getElementById('gallery-save-indicator');
    if (!b) return;
    b.style.display = '';
    setTimeout(()=> b.style.display = 'none', 1200);
  }
  function editElems(){ return document.querySelectorAll('#gallery-card .edit-only'); }
  function uploadBar(){ return document.getElementById('upload-bar'); }
  function fileInput(){ return document.getElementById('gallery-upload-file'); }
  function tagSelect(){ return document.getElementById('gallery-upload-tag'); }

  /* ========= Image Modal (Bootstrap 4/5 compatible) ========= */
  (function(){
    function showImgModal() {
      var el = document.getElementById('imgModal');
      if (window.bootstrap && bootstrap.Modal) {
        var m = bootstrap.Modal.getOrCreateInstance(el);
        m.show();
      } else if (window.jQuery && $('#imgModal').modal) {
        $('#imgModal').modal('show');
      }
    }
    function hideImgModal() {
      var el = document.getElementById('imgModal');
      if (window.bootstrap && bootstrap.Modal) {
        var m = bootstrap.Modal.getOrCreateInstance(el);
        m.hide();
      } else if (window.jQuery && $('#imgModal').modal) {
        $('#imgModal').modal('hide');
      }
    }
    // Single, unified handler
    document.addEventListener('click', function(e){
      const link = e.target.closest('a.js-open-image');
      if (!link) return;
      e.preventDefault();
      var src = link.getAttribute('href');
      var name = link.dataset.name || 'Image';
      document.getElementById('imgModalPic').setAttribute('src', src);
      document.getElementById('imgModalTitle').textContent = name;
      showImgModal();
    });
    // Close buttons (BS4/BS5)
    document.getElementById('imgModal')?.addEventListener('click', function(e){
      if (e.target.closest('[data-dismiss="modal"], [data-bs-dismiss="modal"]')) {
        e.preventDefault();
        hideImgModal();
      }
    });
  })();

  /* ========= Delete Technology Modal ========= */
  (function(){
    var $delModal = $('#deleteTechModal');
    var $delForm  = $('#deleteTechForm');
    var $delInput = $('#deleteConfirmInput');
    var $delBtn   = $('#deleteSubmitBtn');
    var $delChip  = $('#deleteConfirmTarget');

    $(document).on('click', '.js-open-delete', function(e){
      e.preventDefault();
      var name = $(this).data('name') || '';
      var url  = $(this).data('url')  || '';
      $delForm.attr('action', url);
      $delChip.text(name);
      $delInput.val('').attr('placeholder', name).removeClass('is-valid is-invalid');
      $delBtn.prop('disabled', true);
      $delModal.modal('show');
    });

    $delModal.on('shown.bs.modal', function(){ $delInput.trigger('focus'); });

    $delInput.on('input', function(){
      var target = ($delChip.text() || '').trim();
      var val = ($(this).val() || '').trim();
      var match = (val === target);
      $delBtn.prop('disabled', !match);
      $(this).toggleClass('is-valid', match)
             .toggleClass('is-invalid', !match && val.length > 0);
    });
  })();

  /* ========= Gallery (Edit/Upload/Tag/Delete) ========= */
  (function(){
    // --- Edit / Done / Cancel ---
    const editBtn   = document.getElementById('btn-toggle-gallery-edit');
    const doneBtn   = document.getElementById('btn-done-gallery-edit');
    const cancelBtn = document.getElementById('btn-cancel-gallery-edit');
    let galleryDirty = false;

    function enterEditMode(){
      editElems().forEach(el => el.style.display = '');
      if (editBtn)  editBtn.style.display = 'none';
      if (doneBtn)  doneBtn.style.display = '';
      if (cancelBtn) cancelBtn.style.display = '';
      const saved = document.getElementById('gallery-save-indicator');
      if (saved) saved.style.display = 'none';
    }
    function exitEditMode(){
      editElems().forEach(el => el.style.display = 'none');
      const fi = fileInput(); if (fi) fi.value = '';
      const ts = tagSelect(); if (ts) ts.selectedIndex = 0;
      const dz = uploadBar(); if (dz) dz.classList.remove('dragover');
      if (editBtn)  editBtn.style.display = '';
      if (doneBtn)  doneBtn.style.display = 'none';
      if (cancelBtn) cancelBtn.style.display = 'none';
    }

    if (editBtn)  editBtn.addEventListener('click', enterEditMode);
    if (cancelBtn) cancelBtn.addEventListener('click', ()=>{ galleryDirty = false; exitEditMode(); });
    if (doneBtn)   doneBtn.addEventListener('click', ()=>{ if (galleryDirty) showSavedBadge(); galleryDirty = false; exitEditMode(); });

    // Esc cancels edit mode
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && cancelBtn && cancelBtn.style.display !== 'none') {
        galleryDirty = false; exitEditMode();
      }
    });

    // --- Helper: clear any existing card using the same tag (uniqueness) ---
    async function clearExistingTagsFor(tag){
      if (!tag) return;
      const badges = Array.from(document.querySelectorAll('.gallery-card .tag-badge'))
        .filter(b => b.dataset.tag === tag);

      const tasks = badges.map(badge => {
        const card = badge.closest('.gallery-card');
        if (!card) return Promise.resolve();
        const url  = card.dataset.urlUpdate;
        const name = card.dataset.image;
        const fd = new FormData();
        fd.append('image_name', name);
        fd.append('tag', ''); // clear
        fd.append('csrfmiddlewaretoken', csrfValue());

        return fetch(url, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin',
          headers: { 'X-CSRFToken': csrfValue() }
        }).then(r => { if (!r.ok) throw new Error('Failed to clear existing tag'); });
      });

      await Promise.all(tasks).catch(() => {/* optional: toast/log */});
    }

    // --- Upload (clear duplicates, then upload, then reload) ---
    const dz = uploadBar();
    if (dz) {
      const btnUpload = document.getElementById('btn-gallery-upload');

      async function doUpload(file){
        const url = dz.getAttribute('data-upload-url');
        const chosenTag = (tagSelect()?.value || '').trim();

        try {
          if (chosenTag) {
            await clearExistingTagsFor(chosenTag); // enforce uniqueness before upload
          }

          const fd = new FormData();
          fd.append('image', file);
          fd.append('tag', chosenTag);
          fd.append('csrfmiddlewaretoken', csrfValue());

          const r = await fetch(url, {
            method: 'POST',
            body: fd,
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': csrfValue() }
          });
          if (!r.ok) throw new Error('Upload failed');

          galleryDirty = true;
          location.reload();
        } catch (err) {
          alert(err && err.message ? err.message : 'Upload failed');
        }
      }

      if (btnUpload) btnUpload.addEventListener('click', function(){
        const f = fileInput() && fileInput().files[0];
        if (!f) { alert('Choose an image first.'); return; }
        doUpload(f);
      });
      ;['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('dragover'); }));
      ;['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('dragover'); }));
      dz.addEventListener('drop', e => {
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) doUpload(f);
      });
    }

    // --- Per-card quick tag (also enforces uniqueness) ---
    document.addEventListener('click', async function(e){
      const btn = e.target.closest('.js-quick-tag');
      if (!btn) return;

      const card = btn.closest('.gallery-card');
      if (!card) return;

      const url    = card.dataset.urlUpdate;
      const name   = card.dataset.image;
      const newTag = btn.dataset.tag || '';

      try {
        // If setting SC1/SC2 (or any tag), clear it from others first
        if (newTag) await clearExistingTagsFor(newTag);

        const fd = new FormData();
        fd.append('image_name', name);
        fd.append('tag', newTag);
        fd.append('csrfmiddlewaretoken', csrfValue());

        const resp = await fetch(url, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin',
          headers: { 'X-CSRFToken': csrfValue() }
        });
        if (!resp.ok) throw new Error('Request failed');

        // Update current card badge
        let badge = card.querySelector('.tag-badge');
        if (newTag) {
          if (!badge) { badge = document.createElement('span'); badge.className = 'tag-badge'; card.appendChild(badge); }
          badge.dataset.tag = newTag;
          badge.textContent = newTag;
        } else if (badge) {
          badge.remove();
        }

        // Close dropdown (BS5/BS4)
        const toggleBtn = card.querySelector('[data-bs-toggle="dropdown"]');
        if (window.bootstrap?.Dropdown && toggleBtn) {
          bootstrap.Dropdown.getOrCreateInstance(toggleBtn).hide();
        } else {
          const menu = btn.closest('.dropdown-menu'); if (menu) menu.classList.remove('show');
        }

        galleryDirty = true;
      } catch (err) {
        alert('Could not update tag');
      }
    });

    // --- Delete image ---
    document.addEventListener('click', function(e){
      const del = e.target.closest('.js-del-image');
      if (!del) return;
      if (!confirm('Delete this image?')) return;

      const card = del.closest('.gallery-card');
      const url  = card.dataset.urlDelete;
      const name = card.dataset.image;

      const fd = new FormData();
      fd.append('image_name', name);
      fd.append('csrfmiddlewaretoken', csrfValue());

      fetch(url, {
        method: 'POST',
        body: fd,
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': csrfValue() }
      })
      .then(r => { if(!r.ok) throw new Error('Delete failed'); return r.text(); })
      .then(() => {
        const cell = card.closest('.gallery-cell');
        if (cell) cell.remove();
        galleryDirty = true;
      })
      .catch(() => alert('Could not delete image'));
    });

  })();
})();
</script>

{% endblock javascripts %}
