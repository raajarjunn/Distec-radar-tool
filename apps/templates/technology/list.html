{% extends "layouts/base.html" %}
{% load humanize %}
{% load perm_tags %}
{% load static %}



{% block content %}
{% static 'assets/img/brand/nono image.png' as NO_IMAGE %}

<!-----------------------------------------------------Header-------------------------->

<div class="header bg-darker pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-6 col-7">
          <h6 class="h2 text-white d-inline-block mb-0">Technology</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links breadcrumb-dark mb-0">
              <li class="breadcrumb-item">
                <a href="/"><i class="fas fa-home text-darker"></i></a>
              </li>
              <li class="breadcrumb-item">
                <a class="text-darker" href="#">Dashboards</a>
              </li>
              <li class="breadcrumb-item active text-darker" aria-current="page">Technology</li>
            </ol>
          </nav>
        </div>
        <div class="col-lg-6 col-5 text-right">
          {# place optional header actions here, e.g. buttons #}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt-3">

  {% if messages %}
  <div class="row">
    <div class="col-12">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Controls (SEARCH FIRST, then buttons) -->
  <div class="card mb-3">
    <div class="card-body py-3">
      <form class="w-100" method="get" action=".">
        <div class="controls-bar d-flex align-items-center flex-wrap">

          <!-- SEARCH FIRST: grows to consume remaining space -->
          <div class="search-wrap mb-2 mr-2">
            <div class="input-group input-group-alternative input-group-sm">
              <div class="input-group-prepend">
                <span class="input-group-text"><i class="ni ni-zoom-split-in"></i></span>
              </div>
              <input type="text" name="q" value="{{ q }}" class="form-control"
                     placeholder="Search name, category, description" aria-label="Search technologies">
            </div>
            {# persist state #}
            {% if view_mode %}<input type="hidden" name="view" value="{{ view_mode }}">{% endif %}
            {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}
            {% for c in selected_categories %}<input type="hidden" name="categories" value="{{ c }}">{% endfor %}
            {# CHANGED: persist selected statuses instead of active flags #}
            {% for s in status_selected %}<input type="hidden" name="status" value="{{ s }}">{% endfor %}
          </div>

          <!-- ACTION BUTTONS -->
          <div class="d-flex align-items-center flex-wrap actions">

            <div class="mr-2 mb-2">
              <button class="btn btn-sm btn-dark" type="submit">Search</button>
              {% if q or selected_categories or status_selected %}
                <a class="btn btn-sm btn-link text-dark px-2" href="{% url 'technology_list' %}?view={{ view_mode }}&sort={{ sort }}">Clear</a>
              {% endif %}
            </div>

            <div class="mr-2 mb-2">
              <button type="button" class="btn btn-sm btn-outline-dark" data-toggle="modal" data-target="#filterModal">
                <i class="ni ni-settings-gear-65 mr-1"></i> Filter
              </button>
            </div> 

            <!--------------------------------------------------------------------- Sorting --------------------------------------------------------------------->
            <div class="dropdown mr-2 mb-2">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" id="sortMenu"
                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="ni ni-ui-04 mr-1"></i> Sort: {{ sort_label }}
              </button>

              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="sortMenu" role="menu">

                <a class="dropdown-item {% if sort == 'created_desc' %}active{% endif %}"
                  role="menuitemradio"
                  aria-checked="{% if sort == 'created_desc' %}true{% else %}false{% endif %}"
                  href="?q={{ q|urlencode }}&view={{ view_mode }}&sort=created_desc{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">
                  Newest
                </a>

                <a class="dropdown-item {% if sort == 'created_asc' %}active{% endif %}"
                  role="menuitemradio"
                  aria-checked="{% if sort == 'created_asc' %}true{% else %}false{% endif %}"
                  href="?q={{ q|urlencode }}&view={{ view_mode }}&sort=created_asc{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">
                  Oldest
                </a>

                <div class="dropdown-divider"></div>

                <a class="dropdown-item {% if sort == 'name_asc' %}active{% endif %}"
                  role="menuitemradio"
                  aria-checked="{% if sort == 'name_asc' %}true{% else %}false{% endif %}"
                  href="?q={{ q|urlencode }}&view={{ view_mode }}&sort=name_asc{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">
                  Name A→Z
                </a>

                <a class="dropdown-item {% if sort == 'name_desc' %}active{% endif %}"
                  role="menuitemradio"
                  aria-checked="{% if sort == 'name_desc' %}true{% else %}false{% endif %}"
                  href="?q={{ q|urlencode }}&view={{ view_mode }}&sort=name_desc{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">
                  Name Z→A
                </a>

                <div class="dropdown-divider"></div>

                {# CHANGED: new status-first sort keys #}
                <a class="dropdown-item {% if sort == 'status_active_first' %}active{% endif %}"
                  role="menuitemradio"
                  aria-checked="{% if sort == 'status_active_first' %}true{% else %}false{% endif %}"
                  href="?q={{ q|urlencode }}&view={{ view_mode }}&sort=status_active_first{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">
                  Active first
                </a>

                <a class="dropdown-item {% if sort == 'status_inactive_first' %}active{% endif %}"
                  role="menuitemradio"
                  aria-checked="{% if sort == 'status_inactive_first' %}true{% else %}false{% endif %}"
                  href="?q={{ q|urlencode }}&view={{ view_mode }}&sort=status_inactive_first{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">
                  Inactive first
                </a>

                <a class="dropdown-item {% if sort == 'status_dormant_first' %}active{% endif %}"
                  role="menuitemradio"
                  aria-checked="{% if sort == 'status_dormant_first' %}true{% else %}false{% endif %}"
                  href="?q={{ q|urlencode }}&view={{ view_mode }}&sort=status_dormant_first{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">
                  Dormant first
                </a>

              </div>
            </div>


            <div class="btn-group btn-group-sm mr-2 mb-2" role="group" aria-label="View toggle">
              <a class="btn {% if view_mode == 'cards' %}btn-dark{% else %}btn-outline-dark{% endif %}"
                 href="?{% if q %}q={{ q|urlencode }}&{% endif %}view=cards{% if sort %}&sort={{ sort }}{% endif %}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">Cards</a>
              <a class="btn {% if view_mode == 'table' %}btn-dark{% else %}btn-outline-dark{% endif %}"
                 href="?{% if q %}q={{ q|urlencode }}&{% endif %}view=table{% if sort %}&sort={{ sort }}{% endif %}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">Table</a>
            </div>

            {% if user|can:"add_technology" %}
            <div class="mr-2 mb-2">
              <a href="{% url 'technology_create' %}" class="btn btn-sm btn-dark">Add Technology</a>
            </div>
            {% endif %}

            <div class="mr-2 mb-2">
              <button class="btn btn-sm btn-dark" id="openSelector" type="button">Scorecard Compendium</button>
            </div>

          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Status filter badges -->
  {% if q or selected_categories or status_selected %}
  <div class="mb-3">
    <span class="small text-muted mr-2">Active filters:</span>
    {% if q %}
      <a class="badge badge-dark mr-1" href="?view={{ view_mode }}&sort={{ sort }}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">Search: “{{ q }}” &times;</a>
    {% endif %}
    {% for c in selected_categories %}
      <a class="badge badge-secondary mr-1" href="?q={{ q|urlencode }}&view={{ view_mode }}&sort={{ sort }}{% for c2 in selected_categories %}{% if c2 != c %}&categories={{ c2|urlencode }}{% endif %}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}">{{ c }} &times;</a>
    {% endfor %}

    {# CHANGED: show one badge per selected status with a removal link that keeps the others #}
    {% for s in status_selected %}
      <a class="badge {% if s == 'active' %}badge-success{% elif s == 'inactive' %}badge-warning{% else %}badge-secondary{% endif %} mr-1"
         href="?q={{ q|urlencode }}&view={{ view_mode }}&sort={{ sort }}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s2 in status_selected %}{% if s2 != s %}&status={{ s2 }}{% endif %}{% endfor %}">
        {{ s|capfirst }} &times;
      </a>
    {% endfor %}

    <a class="badge badge-light" href="{% url 'technology_list' %}?view={{ view_mode }}&sort={{ sort }}">Clear all</a>
  </div>
  {% endif %}


  {% if items %}
    {% if view_mode == 'table' %}
      <!-- TABLE VIEW -->
      <div class="card enhanced-card">
        <div class="table-responsive">
          <table class="table table-hover align-items-center mb-0">
            <thead class="thead-light">
              <tr>
                <th class="w-30">Name</th>
                <th>Category</th>
                <th>Status</th>  {# CHANGED header #}
                <th>Created</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for t in items %}
              <tr>
                <td class="font-weight-bold">
                  <a class="tech-link" href="{{ t.get_absolute_url }}">{{ t.name }}</a>
                </td>
                <td>{% if t.category %}<span class="badge badge-secondary">{{ t.category }}</span>{% else %}—{% endif %}</td>
                <td>
                  {# CHANGED: show badge by t.status #}
                  {% if t.status == 'active' %}
                    <span class="badge badge-success">Active</span>
                  {% elif t.status == 'inactive' %}
                    <span class="badge badge-warning">Inactive</span>
                  {% elif t.status == 'dormant' %}
                    <span class="badge badge-secondary">Dormant</span>
                  {% else %}
                    <span class="badge badge-light">—</span>
                  {% endif %}
                </td>
                <td>{{ t.created_at|date:"Y-m-d" }}</td>
                <td class="text-right">
                  <div class="btn-toolbar justify-content-end">
                    <div class="btn-group">
                      <a class="btn btn-sm btn-outline-dark mr-1" href="{{ t.get_absolute_url }}">View</a>
                      {% if user|can:"edit_technology" %}
                        <a class="btn btn-sm btn-outline-dark mr-1" href="{% url 'technology_update' t.pk %}">Edit</a>
                      {% endif %}
                      {% if user|can:"delete_technology" %}
                        <a href="#"
                           class="btn btn-sm btn-outline-danger js-open-delete"
                           data-url="{% url 'technology_delete' t.pk %}"
                           data-name="{{ t.name|escape }}">
                          Delete
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <!-- CARD GRID VIEW -->
      <div class="row">
        {% for t in items %}
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3 mb-3">
          <div class="card h-100 tech-card">
           <div class="card-header d-flex align-items-start tech-card-header">
            <h4 class="mb-0 tech-title" title="{{ t.name }}">{{ t.name }}</h4>
            <div class="ml-auto d-flex align-items-center flex-shrink-0 header-badges">
              {% if t.category %}
                <span class="badge badge-pill badge-primary mr-2">{{ t.category }}</span>
              {% endif %}
              {# CHANGED: status badge #}
              {% if t.status == 'active' %}
                <span class="badge badge-success badge-pill">Active</span>
              {% elif t.status == 'inactive' %}
                <span class="badge badge-warning badge-pill">Inactive</span>
              {% elif t.status == 'dormant' %}
                <span class="badge badge-secondary badge-pill">Dormant</span>
              {% else %}
                <span class="badge badge-light badge-pill">—</span>
              {% endif %}
             </div>
            </div>
            <div class="card-body p-0">
              <div class="tech-thumb">
                <img
                  src="{{ t.card_image_b64|default:NO_IMAGE }}"
                  alt="{{ t.name }} image"
                  loading="lazy"
                  class="img-fluid w-100 h-100"
                  onerror="this.onerror=null;this.src='{{ NO_IMAGE }}';"
                >
                <div class="thumb-gradient"></div>
              </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center tech-card-footer">
              <small class="text-muted">Created {{ t.created_at|date:"Y-m-d" }}</small>
              <div class="btn-toolbar">
                <div class="btn-group">
                  <a href="{{ t.get_absolute_url }}" class="btn btn-sm btn-outline-dark mr-1">View</a>
                  {% if user|can:"edit_technology" %}
                    <a href="{% url 'technology_update' t.pk %}" class="btn btn-sm btn-outline-dark mr-1">Edit</a>
                  {% endif %}
                  {% if user|can:"delete_technology" %}
                    <a href="#"
                       class="btn btn-sm btn-outline-danger js-open-delete"
                       data-url="{% url 'technology_delete' t.pk %}"
                       data-name="{{ t.name|escapejs }}">
                      Delete
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if is_paginated %}
      {% with total=page_obj.paginator.num_pages current=page_obj.number %}
      <nav class="mt-3">
        <ul class="pagination mb-0">

          {# Prev #}
          <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
            <a class="page-link" href="{% if page_obj.has_previous %}?{% if q %}q={{ q|urlencode }}&{% endif %}view={{ view_mode }}&sort={{ sort }}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}&page={{ page_obj.previous_page_number }}{% else %}#{% endif %}">Prev</a>
          </li>

          {# First page #}
          <li class="page-item {% if current == 1 %}active{% endif %}">
            <a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}view={{ view_mode }}&sort={{ sort }}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}&page=1">1</a>
          </li>

          {# Left ellipsis #}
          {% if current > 4 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}

          {# Window around current: current-2 .. current+2, excluding first/last #}
          {% for i in page_obj.paginator.page_range %}
            {% if i > 1 and i < total and i >= current|add:"-2" and i <= current|add:"2" %}
              <li class="page-item {% if i == current %}active{% endif %}">
                <a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}view={{ view_mode }}&sort={{ sort }}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}&page={{ i }}">{{ i }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {# Right ellipsis #}
          {% if current < total|add:"-3" %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}

          {# Last page (only if >1) #}
          {% if total > 1 %}
            <li class="page-item {% if current == total %}active{% endif %}">
              <a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}view={{ view_mode }}&sort={{ sort }}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}&page={{ total }}">{{ total }}</a>
            </li>
          {% endif %}

          {# Next #}
          <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
            <a class="page-link" href="{% if page_obj.has_next %}?{% if q %}q={{ q|urlencode }}&{% endif %}view={{ view_mode }}&sort={{ sort }}{% for c in selected_categories %}&categories={{ c|urlencode }}{% endfor %}{% for s in status_selected %}&status={{ s }}{% endfor %}&page={{ page_obj.next_page_number }}{% else %}#{% endif %}">Next</a>
          </li>

        </ul>
      </nav>
      {% endwith %}
    {% endif %}

  {% else %}
    <div class="card enhanced-card">
      <div class="card-body text-center text-muted">
        <p class="mb-2">No technologies found.</p>
        {% if user|can:"add_technology" %}
          <a href="{% url 'technology_create' %}" class="btn btn-dark">Create your first one</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<!-- FILTER MODAL -->
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="get" action=".">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="filterLabel">Filter technologies</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>

        <div class="modal-body pt-2">
          <input type="hidden" name="q" value="{{ q }}">
          <input type="hidden" name="view" value="{{ view_mode }}">
          <input type="hidden" name="sort" value="{{ sort }}">

          <!-- Categories -->
          <div class="mb-3">
            <label class="form-label d-block mb-2">Categories</label>
            <div class="category-scroll">
              {% for c in all_categories %}
                <div class="badge-check small dark w-100 mb-2">
                  <input type="checkbox" id="cat-{{ forloop.counter }}" name="categories" value="{{ c }}" {% if c in selected_categories %}checked{% endif %}>
                  <label class="d-flex align-items-center justify-content-between" for="cat-{{ forloop.counter }}">
                    <span><i class="ni ni-tag mr-2"></i>{{ c }}</span>
                  </label>
                </div>
              {% empty %}
                <small class="text-muted">No categories yet.</small>
              {% endfor %}
            </div>
          </div>
          <!-- Status -->
          <div class="mb-1">
            <label class="form-label d-block mb-2">Status</label>
            <div class="form-row">
              <div class="col-auto">
                <div class="custom-control custom-checkbox">
                  <input class="custom-control-input" type="checkbox" id="statActive" name="status" value="active"
                        {% if "active" in status_selected %}checked{% endif %}>
                  <label class="custom-control-label" for="statActive">Active</label>
                </div>
              </div>
              <div class="col-auto">
                <div class="custom-control custom-checkbox">
                  <input class="custom-control-input" type="checkbox" id="statInactive" name="status" value="inactive"
                        {% if "inactive" in status_selected %}checked{% endif %}>
                  <label class="custom-control-label" for="statInactive">Inactive</label>
                </div>
              </div>
              <div class="col-auto">
                <div class="custom-control custom-checkbox">
                  <input class="custom-control-input" type="checkbox" id="statDormant" name="status" value="dormant"
                        {% if "dormant" in status_selected %}checked{% endif %}>
                  <label class="custom-control-label" for="statDormant">Dormant</label>
                </div>
              </div>
            </div>
            <small class="text-muted d-block mt-1">Select multiple to include more than one status.</small>
          </div>
        </div>

        <div class="modal-footer border-0 pt-0">
          <a href="{% url 'technology_list' %}?view={{ view_mode }}&sort={{ sort }}" class="btn btn-link">Reset</a>
          <button type="submit" class="btn btn-dark btn-sm">Apply filters</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteTechModal" tabindex="-1" role="dialog" aria-labelledby="deleteTechModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-danger modal-dialog-centered modal-10" role="document">
    <div class="modal-content bg-gradient-danger text-white">
      <form id="deleteTechForm" method="post" action="">
        {% csrf_token %}
        <div class="modal-header border-0">
          <h6 class="modal-title text-white" id="deleteTechModalLabel">Your attention is required</h6>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
        </div>
        <div class="modal-body">
          <div class="text-center py-2">
            <div class="icon icon-shape bg-white text-danger rounded-circle shadow mb-3" style="width:56px;height:56px;display:inline-flex;align-items:center;justify-content:center;"><i class="ni ni-bell-55"></i></div>
            <h4 class="text-uppercase text-white mb-1" style="letter-spacing:.08em;">This action cannot be undone</h4>
            <p class="mb-2">Type the technology name to confirm deletion:</p>
            <span id="deleteConfirmTarget" class="name-chip"></span>
          </div>
          <div class="confirm-box mt-3">
            <label class="small text-uppercase mb-1 text-muted">Type name to confirm</label>
            <input type="text" class="form-control form-control-lg" id="deleteConfirmInput" name="confirm_name" placeholder="">
            <small class="text-muted d-block mt-1">You must type the name exactly.</small>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-link text-white ml-auto" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-white btn-lg" id="deleteSubmitBtn" disabled>Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% include "Scorecard/Selector.html" %}

{% endblock %}

{% block stylesheets %}
{{ block.super }}
<style>
  /* Header breadcrumb slashes + text on WHITE header → black */
  .header.bg-white .breadcrumb .breadcrumb-item + .breadcrumb-item::before { color: #343a40 !important; opacity: .9; }
  .header.bg-white .breadcrumb .breadcrumb-item,
  .header.bg-white .breadcrumb .breadcrumb-item a,
  .header.bg-white .breadcrumb .breadcrumb-item i { color: #111 !important; }

  /* Slightly larger page title on white header */
  .header .h2 { font-size: 1.75rem; color:#111; }

  /* Controls bar */
  .controls-bar { gap: .5rem; }
  .controls-bar .actions > * { flex: 0 0 auto; }
  .controls-bar .search-wrap { flex: 1 1 360px; min-width: 260px; }
  .controls-bar .search-wrap .input-group { width: 100%; }

  /* Buttons theme */
  .btn-outline-dark, .btn-outline-danger { border-width: 1px; }
  .btn-group .btn + .btn { margin-left: 1px; }

  /* Enhanced neutral cards (NO green/red borders) */
  .enhanced-card { border-radius: 16px; overflow: hidden; border: 1px solid #e9ecef; }
  .tech-card {
    border-radius: 16px;
    border: 1px solid #e9ecef;   /* neutral border only */
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    transition: box-shadow .18s ease, transform .18s ease;
    overflow: hidden;
  }
  /* remove colored status borders (kept empty intentionally) */
  .tech-card.tech-active {}
  .tech-card.tech-inactive {}

  .tech-card:hover { box-shadow: 0 12px 30px rgba(0,0,0,.12); transform: translateY(-2px); }

  .tech-card-header {
    background: #fff;
    border-bottom: 1px solid #f0f2f5;
    padding: .9rem 1rem;
  }
  .tech-card-footer {
    background: #fff;
    border-top: 1px solid #f0f2f5;
    padding: .65rem 1rem;
  }

  /* Bigger, bolder card title */
  .tech-title {
  font-weight: 800;
  font-size: 1.2rem;
  letter-spacing: .01em;
  color: #111;
  /* remove these if present: max-width, text-overflow, white-space, overflow */
  max-width: none;
  white-space: normal;
  overflow: visible;
  text-overflow: clip;
  margin-right: .5rem; /* small breathing room before badges on small screens */
}

@media (min-width: 1200px){
  .tech-title { font-size: 1.3rem; }
}

  /* Keep badges on the far right, on one line, and prevent squishing */
  .header-badges { gap: .35rem; }
  .header-badges .badge { flex: 0 0 auto; }

  .tech-card-header {
  font-weight: 800;
  font-size: 1.2rem;
  letter-spacing: .01em;
  color: #111;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;  /* allow two lines */
  -webkit-box-orient: vertical;
}

  /* Thumbnail polish */
  .tech-thumb { position: relative; width: 100%; padding-top: 56.25%; overflow: hidden; }
  .tech-thumb img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transform: scale(1.001); }
  .thumb-gradient { position:absolute; left:0; right:0; bottom:0; height:42%; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.08) 40%, rgba(0,0,0,.18) 100%); }

  /* Clamp description in card view */
  .tech-desc { display:-webkit-box; -webkit-line-clamp:5; -webkit-box-orient:vertical; overflow:hidden; min-height:5.2em; }

  /* Table link style */
  .tech-link { color:#172b4d; }
  .tech-link:hover { color:#000; text-decoration:none; }

  dropdown-item.active,
  .dropdown-item:active {
    background: #212529;
    color: #fff;
  }

  /* Filter modal category list */
  .badge-check input { display:none; }
  .badge-check.small.dark label{
    display:block; width:100%; cursor:pointer; user-select:none;
    padding:.35rem .65rem; border-radius:999px;
    border:1px solid rgba(0,0,0,.18); background:#f6f9fc; color:#212529; font-weight:600; font-size:.8rem;
    transition:all .15s ease;
  }
  .badge-check.small.dark input:checked + label{ background:#212529; border-color:#212529; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,.25); }
  .badge-check.small.dark label:hover{ transform:translateY(-1px); }
  .category-scroll{ max-height:240px; overflow-y:auto; overflow-x:hidden; padding-right:.25rem; }

  /* Delete modal polish */
  #deleteTechModal .name-chip{ display:inline-block; padding:.5rem 1rem; font-weight:700; font-size:1.125rem; color:#e63946; background:#fff; border-radius:999px; box-shadow:0 6px 18px rgba(0,0,0,.15); }
  #deleteTechModal .confirm-box{ background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); border-radius:.75rem; padding:1rem; -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px); }
  #deleteTechModal .confirm-box .form-control{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:.5rem; }
  #deleteTechModal .form-control.is-valid{ border-color:#2dce89!important; box-shadow:0 0 0 .2rem rgba(45,206,137,.25); }
  #deleteTechModal .form-control.is-invalid{ border-color:#f5365c!important; box-shadow:0 0 0 .2rem rgba(245,54,92,.25); }


  /* ---------- CARD HEADER: force uniform height + clamp title + pin badges ---------- */
.tech-card { display: flex; flex-direction: column; }
.tech-card .card-body { flex: 1 1 auto; }

/* Override any previous flex/wrap rules */
.tech-card-header{
  position: relative;
  display: grid !important;                /* beat earlier flex rules */
  grid-template-columns: 1fr auto;
  align-items: start;
  gap: .5rem;
  padding: .75rem 1rem;
  height: 72px !important;                 /* FIXED height = all images align */
  border-bottom: 1px solid #f0f2f5;
  background: #fff;
  overflow: hidden;                         /* hide anything beyond 2 lines */
}

/* Title: two-line clamp; smaller size */
.tech-title{
  font-weight: 800;
  font-size: 1.02rem !important;           /* smaller than before */
  line-height: 1.25;
  letter-spacing: .01em;
  color: #111;
  margin: 0;
  overflow: hidden !important;
  display: -webkit-box !important;
  -webkit-line-clamp: 2;                    /* cap to 2 lines */
  -webkit-box-orient: vertical;
  /* Safety in non-webkit: cap by max-height (2 lines) */
  max-height: calc(1.25em * 2);
}

/* Badges: never wrap, never shrink, stay top-right */
.header-badges{
  display: flex !important;
  gap: .35rem;
  align-items: flex-start;
  white-space: nowrap;
  flex-shrink: 0 !important;
}

/* Make sure previous rules that caused wrapping can't apply */
.tech-card-header .header-badges .badge{ flex: 0 0 auto; }
@media (max-width: 575.98px){
  .tech-card-header{ height: 64px !important; padding: .65rem .9rem; }
  .tech-title{ font-size: .96rem !important; line-height: 1.2; max-height: calc(1.2em * 2); }
}


  /* Mobile nits */
  @media (max-width:575.98px){
    .input-group-text{ padding:.375rem .5rem; }
    .tech-title { font-size: 1.15rem; }

    
  }
</style>
{% endblock stylesheets %}

{% block javascripts %}
{{ block.super }}

<script>
(function () {
  // ===== Helpers for special characters / Unicode normalization =====
  // ===== Helpers for special characters / Unicode normalization =====
function decodeJsEscapes(str) {
  var s = String(str || "");
  // handle double-escaped sequences first: \\uXXXX -> \uXXXX
  s = s.replace(/\\\\u/g, '\\u').replace(/\\\\x/g, '\\x');

  // \u{1F600} (code point)
  s = s.replace(/\\u\{([0-9a-fA-F]+)\}/g, function(_, hex){
    try { return String.fromCodePoint(parseInt(hex, 16)); } catch { return _; }
  });
  // \u00XX (BMP)
  s = s.replace(/\\u([0-9a-fA-F]{4})/g, function(_, hex){
    return String.fromCharCode(parseInt(hex, 16));
  });
  // \xNN
  s = s.replace(/\\x([0-9a-fA-F]{2})/g, function(_, hex){
    return String.fromCharCode(parseInt(hex, 16));
  });
  return s;
}

function decodeEntities(str) {
  if (!str) return "";
  var el = document.createElement('textarea');
  el.innerHTML = str;
  return el.value;
}

function normalizeText(str) {
  var s = String(str || "");
  // 1) HTML entities (&amp;, &#x2013;, &nbsp;)
  s = decodeEntities(s);
  // 2) JS/JSON unicode escapes (\u002D, \x2D, \u{2D})
  s = decodeJsEscapes(s);
  // 3) Whitespace + invisibles
  s = s.replace(/\u00A0/g, ' ')
       .replace(/[\u200B-\u200D\uFEFF]/g, '')
       .replace(/\s+/g, ' ')
       .trim();
  // 4) Unicode normalization so composed/decomposed forms match
  if (typeof s.normalize === 'function') s = s.normalize('NFC');
  return s;
}

  // Delete modal wiring
  function bindDeleteModal($) {
    var targetName = "", actionUrl = "";
    var $modal = $('#deleteTechModal'), $form = $('#deleteTechForm'), $input = $('#deleteConfirmInput');
    var $btn = $('#deleteSubmitBtn'), $chip = $('#deleteConfirmTarget');

    $(document).on('click', '.js-open-delete', function (e) {
      e.preventDefault();

      // Read raw from data-* (prefer attr in case jQuery caching misses updates)
      var rawName = $(this).attr('data-name');
      targetName  = normalizeText(rawName || $(this).data('name') || "");
      actionUrl   = $(this).data('url') || "";

      $form.attr('action', actionUrl);
      $chip.text(targetName); // safe for special chars
      $input.val('')
            .attr('placeholder', targetName) // placeholder handles special chars fine
            .removeClass('is-valid is-invalid');
      $btn.prop('disabled', true);
      $modal.modal('show');
    });

    $modal.on('shown.bs.modal', function () { $input.trigger('focus'); });

    $input.on('input', function () {
      var val = $(this).val() || "";
      var normVal = normalizeText(val);
      var match = (normVal === targetName);

      $btn.prop('disabled', !match);
      $input.toggleClass('is-valid', match)
            .toggleClass('is-invalid', !match && normVal.length > 0);
    });
  }

  (function waitForBootstrap(tries) {
    tries = tries || 40;
    if (window.jQuery && window.jQuery.fn && window.jQuery.fn.modal) { bindDeleteModal(window.jQuery); return; }
    if (tries <= 0) return;
    setTimeout(function(){ waitForBootstrap(tries-1); }, 150);
  })();
})();
</script>

<script>
/* ========= Delete Modal close compatibility (BS4/BS5) ========= */
(function(){
  var el = document.getElementById('deleteTechModal');

  function hideDelModal(){
    if (window.bootstrap && bootstrap.Modal) {
      bootstrap.Modal.getOrCreateInstance(el).hide();
    } else if (window.jQuery && window.jQuery.fn && window.jQuery.fn.modal) {
      window.jQuery(el).modal('hide');
    }
  }

  if (el) {
    el.addEventListener('click', function(e){
      if (e.target.closest('[data-dismiss="modal"], [data-bs-dismiss="modal"]')) {
        e.preventDefault();
        hideDelModal();
      }
    });
  }
})();
</script>

{% endblock javascripts %}
