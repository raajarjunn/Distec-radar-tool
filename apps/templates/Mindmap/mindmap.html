{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Mind Map{% endblock title %}
{% block sidebar %}{% endblock sidebar %}


{% block stylesheets %}
  {# MindElixir CSS #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mind-elixir@0.8.2/dist/mind-elixir.min.css"/>

  <style>
    /* Breadcrumb chip: dark text on white chip over black header */
    .header.bg-darker .crumb-light{
      background:#fff; padding:.35rem .75rem; border-radius:.5rem; display:inline-flex;
    }
    .header.bg-darker .crumb-light .breadcrumb-item,
    .header.bg-darker .crumb-light .breadcrumb-item a,
    .header.bg-darker .crumb-light .breadcrumb-item i{ color:#111 !important; }
    .header.bg-darker .crumb-light .breadcrumb-item + .breadcrumb-item::before{
      color:#111 !important; opacity:.85;
    }

    /* Page card aesthetics (slight glass/soft) */
    .mind-card{
      border:1px solid rgba(255,255,255,0.25);
      border-radius:16px;
      background: rgba(255,255,255,0.9);
      box-shadow:0 8px 24px rgba(0,0,0,.10);
      backdrop-filter:saturate(120%) blur(6px);
      -webkit-backdrop-filter:saturate(120%) blur(6px);
      overflow:hidden;
    }

    /* Actions bar */
    .mind-actions{ gap:.5rem; }
    .mind-actions .btn + .btn{ margin-left:.25rem; }

    /* The canvas/viewport for the mind map */
    #mindMapContainer{
      width:100%;
      height:72vh;                 /* responsive height */
      min-height:560px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      background:#fff;             /* keep map crisp on busy backgrounds */
    }

    /* Make capture button compact and on-theme */
  .btn-dark, .btn-outline-dark{ border-width:1px; }

  #sidenav-main, .sidenav, .navbar-vertical { display:none !important; }

  /* Remove the left offset the layout gives to content when a sidenav exists */
  .main-content { margin-left:0 !important; }

  /* If your header/content has extra padding left when sidenav is present: */
  .header, .container-fluid { padding-left: 1rem !important; } /* tweak as needed */

  /* Force the root title to wrap and center */
  /* Limit + wrap + center ONLY the root's title */
  /* Center + wrap the ROOT node title only */
.me-root .me-title{
  display:block !important;
  text-align:center !important;
  text-indent:0 !important;

  /* allow multi-line wrapping */
  white-space:normal !important;
  overflow-wrap:anywhere !important;
  word-break:break-word !important;
  line-height:1.25;
  padding:.25rem .5rem;
  max-width:420px;         /* tweak width as you like */
  margin:0 auto;           /* center the block itself */
}

/* Some themes add justification glyphs via pseudo elements — kill them */
.me-root .me-title::before,
.me-root .me-title::after{
  content:none !important;
  display:none !important;
}

/* (Optional) constrain the root node box a bit */
.me-root{
  max-width:420px !important;   /* keep the bubble from stretching */
}

  

  </style>
{% endblock stylesheets %}

{% block content %}

<!-- Header — same size and color as your other black headers -->
<div class="header bg-darker pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col">
          <h6 class="h2 text-white d-inline-block mb-0">Mind Map</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links mb-0 crumb-light">
              <li class="breadcrumb-item">
                <a href="/"><i class="fas fa-home"></i></a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">Mind Map</li>
            </ol>
          </nav>
        </div>
        <div class="col-auto">
          <!-- optional header actions could go here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="card mind-card">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between mind-actions mb-3">
        <h4 class="mb-2 mb-sm-0">Workspace</h4>
        <div class="d-flex flex-wrap">
          <button id="captureBtn" class="btn btn-dark btn-sm">Capture as PNG</button>
        </div>
      </div>

      <div id="mindMapContainer"></div>
    </div>
  </div>

</div>
{% endblock content %}

{% block javascripts %}
  {# MindElixir JS (served from your static folder) #}
  <script src="{% static 'js/MindElixir.min.js' %}"></script>
  {# html2canvas for screenshots #}
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    let mind;

    function generateUUID() {
      return 'id-' + Math.random().toString(36).substr(2, 9);
    }

    function getNodeDepth(root, id, depth = 0) {
      if (root.id === id) return depth;
      if (root.children) {
        for (let child of root.children) {
          const d = getNodeDepth(child, id, depth + 1);
          if (d !== -1) return d;
        }
      }
      return -1;
    }

    function assignIdsAndTypes(node, depth = 0) {
      if (!node.id) node.id = generateUUID();
      if (!node.data) node.data = {};
      node.data.type = ['macro', 'meso', 'micro'][depth] || 'unknown';
      if (!node.children) node.children = [];
      node.children.forEach(child => assignIdsAndTypes(child, depth + 1));
    }

    async function captureMindMap() {
      const el = document.getElementById('mindMapContainer');
      const canvas = await html2canvas(el, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      });
      const dataURL = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      a.href = dataURL;
      a.download = `mindmap-${timestamp}.png`;
      a.click();
    }

    document.addEventListener('DOMContentLoaded', function () {
      const dataStr = '{{ mindmap_json|escapejs }}';
      const mindmapData = JSON.parse(dataStr);

      mind = new MindElixir({
        el: '#mindMapContainer',
        direction: MindElixir.LEFT,
        draggable: true,
        contextMenu: true,
        toolBar: true,
        nodeMenu: true,
        keypress: true,
      });

      assignIdsAndTypes(mindmapData.nodeData);
      mind.init(mindmapData);
      const rootTitle = document.querySelector(`.me-node[data-nodeid="${mind.getData().nodeData.id}"] .me-title`);
        if (rootTitle) {
          rootTitle.style.setProperty('text-align', 'center', 'important');
          rootTitle.style.removeProperty('text-justify');
        }

      // after mind.init(mindmapData);
      requestAnimationFrame(() => {
        const el = document.querySelector('.me-root .me-title');
        if (el) el.style.textAlign = 'center'; // CSS already does it; this just nudges.
      });



          mind.bus.addListener('operation', op => {
            if (op.name === 'addChild' || op.name === 'addSibling') {
              const node = op.obj;
              if (!node.id) node.id = generateUUID();
              if (!node.data) node.data = {};
              const depth = getNodeDepth(mind.getData().nodeData, node.id);
              node.data.type = ['macro', 'meso', 'micro'][depth] || 'unknown';
            }
          });

          document.getElementById('captureBtn').addEventListener('click', captureMindMap);
        });

    // Tag the root node in the rendered DOM so CSS only hits that one
    

      </script>
{% endblock javascripts %}
