{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Mind Map{% endblock title %}
{% block sidebar %}{% endblock sidebar %}


{% block stylesheets %}
{# MindElixir CSS #}
 

  <style>
    /* Breadcrumb chip: dark text on white chip over black header */
    .header.bg-darker .crumb-light{
      background:#fff; padding:.35rem .75rem; border-radius:.5rem; display:inline-flex;
    }
    .header.bg-darker .crumb-light .breadcrumb-item,
    .header.bg-darker .crumb-light .breadcrumb-item a,
    .header.bg-darker .crumb-light .breadcrumb-item i{ color:#111 !important; }
    .header.bg-darker .crumb-light .breadcrumb-item + .breadcrumb-item::before{
      color:#111 !important; opacity:.85;
    }

    /* Page card aesthetics (slight glass/soft) */
    .mind-card{
      border:1px solid rgba(255,255,255,0.25);
      border-radius:16px;
      background: rgba(255,255,255,0.9);
      box-shadow:0 8px 24px rgba(0,0,0,.10);
      backdrop-filter:saturate(120%) blur(6px);
      -webkit-backdrop-filter:saturate(120%) blur(6px);
      overflow:hidden;
    }

    /* Actions bar */
    .mind-actions{ gap:.5rem; }
    .mind-actions .btn + .btn{ margin-left:.25rem; }

    /* The canvas/viewport for the mind map */
    #mindMapContainer{
      width:100%;
      height:72vh;                 /* responsive height */
      min-height:560px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      background:#fff;  
      margin: 0 auto !important;
      transform: translateX(0) !important;           /* keep map crisp on busy backgrounds */
    }

    /* Make capture button compact and on-theme */
  .btn-dark, .btn-outline-dark{ border-width:1px; }

  #sidenav-main, .sidenav, .navbar-vertical { display:none !important; }

  /* Remove the left offset the layout gives to content when a sidenav exists */
  .main-content { margin-left:0 !important; }

  /* If your header/content has extra padding left when sidenav is present: */
  .header, .container-fluid { padding-left: 1rem !important; } /* tweak as needed */

  /* Force the root title to wrap and center */
  /* Limit + wrap + center ONLY the root's title */
  /* Center + wrap the ROOT node title only */
.me-root .me-title{
  display:block !important;
  text-align:center !important;
  text-indent:0 !important;

  /* allow multi-line wrapping */
  white-space:normal !important;
  overflow-wrap:anywhere !important;
  word-break:break-word !important;
  line-height:1.25;
  padding:.25rem .5rem;
  max-width:420px;         /* tweak width as you like */
  margin:0 auto;           /* center the block itself */
}

/* Some themes add justification glyphs via pseudo elements — kill them */
.me-root .me-title::before,
.me-root .me-title::after{
  content:none !important;
  display:none !important;
}

/* (Optional) constrain the root node box a bit */
.me-root{
  max-width:420px !important;   /* keep the bubble from stretching */
}

.alert-warning {
  background: #ffffff;
  border: 1px solid #fdfdfd;
  color: #000000;
}


  

  </style>
{% endblock stylesheets %}

{% block content %}

<!-- Header — same size and color as your other black headers -->
<div class="header bg-darker pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col">
          <h6 class="h2 text-white d-inline-block mb-0">Mind Map</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links mb-0 crumb-light">
              <li class="breadcrumb-item">
                <a href="/"><i class="fas fa-home"></i></a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">Mind Map</li>
            </ol>
          </nav>
        </div>
        <div class="col-auto">
          <!-- optional header actions could go here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="card mind-card">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between mind-actions mb-3">
        <h4 class="mb-2 mb-sm-0">Workspace</h4>
        <div class="d-flex flex-wrap">
          <button id="captureBtn" class="btn btn-dark btn-sm">Capture as PNG</button>
        </div>
      </div>

      <!-- Note: Mind map visualization notice -->
      <div class="alert alert-warning py-2 px-3 mb-3" style="border-radius:8px; font-size:0.9rem;">
        ⚠️ <strong>Note:</strong> The Mind Map is for visualization purposes only — any changes made here will not be saved.
      </div>

      <div id="mindMapContainer"></div>
    </div>
  </div>

</div>
{% endblock content %}

{% block javascripts %}
  <script src="{% static 'js/MindElixir.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    let mind;

    // ----- Zoom config (tweak as you like) -----
    const ZOOM_MIN  = 0.01;   // 1%
    const ZOOM_MAX  = 10.0;   // 1000%
    const ZOOM_STEP = 1.2;    // toolbar dblclick step (≈20%)
    const WHEEL_STEP = 1.15;  // Ctrl/⌘+wheel step (≈15%)

    // ----- Helpers -----
    const genId = () => 'id-' + Math.random().toString(36).slice(2);

    function getDepth(root, id, d = 0){
      if (root.id === id) return d;
      for (const c of (root.children || [])) {
        const r = getDepth(c, id, d + 1);
        if (r !== -1) return r;
      }
      return -1;
    }

    function tagIdsTypes(node, depth = 0){
      node.id ||= genId();
      node.data ||= {};
      node.data.type = ['macro','meso','micro'][depth] || 'unknown';
      (node.children || []).forEach(ch => tagIdsTypes(ch, depth + 1));
    }

    async function capturePNG(){
      const el = document.getElementById('mindMapContainer');
      const canvas = await html2canvas(el, { backgroundColor:'#fff', scale:2, useCORS:true, logging:false });
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `mindmap-${new Date().toISOString().replace(/[:.]/g,'-')}.png`;
      a.click();
    }

    // ----- Zoom control -----
    function clampZoom(v){ return Math.min(ZOOM_MAX, Math.max(ZOOM_MIN, v)); }
    function setScale(val){
      mind.scale(clampZoom(val));
      const z = document.getElementById('zoomLevel');
      if (z) z.textContent = Math.round(mind.scaleVal * 100) + '%';
    }

    function installUnlimitedWheelZoom(){
      const el = document.querySelector('#mindMapContainer .map-canvas') || document.getElementById('mindMapContainer');

      // Intercept Ctrl/⌘+wheel to override library's caps
      el.addEventListener('wheel', (evt)=>{
        if (!(evt.ctrlKey || evt.metaKey)) return;
        evt.preventDefault();
        evt.stopPropagation();

        const factor = evt.deltaY < 0 ? WHEEL_STEP : 1 / WHEEL_STEP;
        setScale(mind.scaleVal * factor);
      }, { passive: false, capture: true });

      // Double-click to zoom in; Shift+double-click to zoom out
      el.addEventListener('dblclick', (evt)=>{
        if (evt.shiftKey) setScale(mind.scaleVal / ZOOM_STEP);
        else setScale(mind.scaleVal * ZOOM_STEP);
      });
    }

    // ----- Toolbar (with fullscreen + zoom readout) -----
    function makeToolbar(){
      const bar = document.createElement('div');
      bar.id = 'mindToolbar';
      bar.innerHTML = `
        <button data-act="left"      title="Left">⟵</button>
        <button data-act="right"     title="Right">⟶</button>
        <button data-act="side"      title="Side">⇄</button>
        <span class="sep"></span>
        <button data-act="center"    title="Center">◎</button>
        <button data-act="fit"       title="Fit">▭</button>
        <span class="sep"></span>
        <button data-act="zoomout"   title="Zoom Out">−</button>
        <span id="zoomLevel">100%</span>
        <button data-act="zoomin"    title="Zoom In">＋</button>
        <span class="sep"></span>
        <button data-act="fullscreen" title="Fullscreen">⤢</button>
      `;
      document.body.appendChild(bar);

      const container = document.querySelector('#mindMapContainer');

      bar.addEventListener('click', (e)=>{
        const act = e.target?.dataset?.act;
        if (!act || !mind) return;

        switch(act){
          case 'left':      mind.initLeft();  mind.toCenter(); break;
          case 'right':     mind.initRight(); mind.toCenter(); break;
          case 'side':      mind.initSide();  mind.toCenter(); break;
          case 'center':    mind.toCenter();  break;
          case 'fit':       mind.scaleFit();  mind.toCenter(); break;
          case 'zoomin':    setScale(mind.scaleVal * ZOOM_STEP); break;
          case 'zoomout':   setScale(mind.scaleVal / ZOOM_STEP); break;
          case 'fullscreen':
            if (!document.fullscreenElement) container.requestFullscreen?.();
            else document.exitFullscreen?.();
            break;
        }
      });
    }

    // ----- Boot -----
    document.addEventListener('DOMContentLoaded', function () {
      const dataStr = '{{ mindmap_json|escapejs }}';
      const mindmapData = JSON.parse(dataStr);
      tagIdsTypes(mindmapData.nodeData);

      mind = new MindElixir({
        el: '#mindMapContainer',
        direction: MindElixir.SIDE,  // balanced both sides
        alignment: 'nodes',          // center whole graph
        draggable: true,
        contextMenu: true,
        toolBar: false,              // we use custom toolbar
        nodeMenu: true,
        keypress: true,
        scaleSensitivity: 0.1        // finer built-in step (doesn't cap us)
      });

      mind.init(mindmapData);
      mind.initSide();
      mind.toCenter();

      // Keep centered on edits/resizes
      mind.bus.addListener('operation', op => {
        if (op.name === 'addChild' || op.name === 'addSibling') {
          const node = op.obj;
          node.id ||= genId();
          node.data ||= {};
          const depth = getDepth(mind.getData().nodeData, node.id);
          node.data.type = ['macro','meso','micro'][depth] || 'unknown';
        }
        if (['addChild','addSibling','removeNode','moveNode','finishEdit'].includes(op.name)) {
          requestAnimationFrame(() => mind.toCenter());
        }
      });
      window.addEventListener('resize', () => mind.toCenter());

      // Keep root title visually centered
      requestAnimationFrame(()=>{
        const t = document.querySelector('.me-root .me-title');
        if (t) t.style.textAlign = 'center';
      });

      // Existing PNG capture button
      const cap = document.getElementById('captureBtn');
      if (cap) cap.addEventListener('click', capturePNG);

      // Build UI + install unlimited zoom
      makeToolbar();
      installUnlimitedWheelZoom();
      setScale(1); // show 100% initially
    });
  </script>

  <style>
    /* Floating toolbar */
    #mindToolbar{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      background: #fff;
      border: 1px solid rgba(0,0,0,.1);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      padding: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    #mindToolbar .sep{ width:1px; height:20px; background:rgba(0,0,0,.12); margin:0 4px; }
    #mindToolbar button{
      border: 1px solid rgba(0,0,0,.12);
      background: #f9f9f9;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    #mindToolbar button:hover{ filter: brightness(0.97); }
    #mindToolbar button:active{ transform: translateY(1px); }
    #zoomLevel{ min-width: 48px; text-align:center; font-size:13px; color:#333; }
  </style>
{% endblock javascripts %}
