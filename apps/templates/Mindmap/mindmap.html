{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Mind Map</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mind-elixir@0.8.2/dist/mind-elixir.min.css" />
  <script src="{% static 'js/MindElixir.min.js' %}"></script>

  <!-- html2canvas for screenshots -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    #mindMapContainer { width: 100%; height: 700px; border: 1px solid #2c0101; }
    .actions { margin: 10px 0 14px; }
    .actions button { padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Mind Map</h2>

  <div class="actions">
    <button id="captureBtn">Capture as PNG</button>
  </div>

  <div id="mindMapContainer"></div>

<script>
  let mind;

  function generateUUID() {
    return 'id-' + Math.random().toString(36).substr(2, 9);
  }

  function getNodeDepth(root, id, depth = 0) {
    if (root.id === id) return depth;
    if (root.children) {
      for (let child of root.children) {
        const d = getNodeDepth(child, id, depth + 1);
        if (d !== -1) return d;
      }
    }
    return -1;
  }

  function assignIdsAndTypes(node, depth = 0) {
    if (!node.id) node.id = generateUUID();
    if (!node.data) node.data = {};
    node.data.type = ['macro', 'meso', 'micro'][depth] || 'unknown';
    if (!node.children) node.children = [];
    node.children.forEach(child => assignIdsAndTypes(child, depth + 1));
  }

  // Capture screenshot
  async function captureMindMap() {
    const el = document.getElementById('mindMapContainer');
    const canvas = await html2canvas(el, {
      backgroundColor: '#ffffff',
      scale: 2,
      useCORS: true,
      logging: false
    });
    const dataURL = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    a.href = dataURL;
    a.download = `mindmap-${timestamp}.png`;
    a.click();
  }

  window.onload = function () {
    const mindmapData = JSON.parse('{{ mindmap_json|escapejs }}');
    mind = new MindElixir({
      el: '#mindMapContainer',
      direction: MindElixir.RIGHT,
      draggable: true,
      contextMenu: true,
      toolBar: true,
      nodeMenu: true,
      keypress: true,
    });

    assignIdsAndTypes(mindmapData.nodeData);
    mind.init(mindmapData);

    mind.bus.addListener('operation', op => {
      if (op.name === 'addChild' || op.name === 'addSibling') {
        const node = op.obj;
        if (!node.id) node.id = generateUUID();
        if (!node.data) node.data = {};
        const depth = getNodeDepth(mind.getData().nodeData, node.id);
        node.data.type = ['macro', 'meso', 'micro'][depth] || 'unknown';
        console.log("Assigned:", node.topic, node.id, node.data.type);
      }
    });

    // Only Capture button
    document.getElementById('captureBtn').addEventListener('click', captureMindMap);
  };
</script>
</body>
</html>
