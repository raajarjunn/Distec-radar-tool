{# apps/templates/technology/create.html #}
{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<style>
  /* ======= Compact, performant gallery ======= */
  .gallery-toolbar { gap: .5rem; }
  .gallery-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: .75rem; }
  @media (max-width: 1400px){ .gallery-grid { grid-template-columns: repeat(12, 1fr); } }
  @media (max-width: 1200px){ .gallery-grid { grid-template-columns: repeat(12, 1fr); } }
  @media (max-width: 992px){  .gallery-grid { grid-template-columns: repeat(8, 1fr); } }
  @media (max-width: 768px){  .gallery-grid { grid-template-columns: repeat(6, 1fr); } }
  @media (max-width: 576px){  .gallery-grid { grid-template-columns: repeat(4, 1fr); } }

  /* Each card spans columns responsively (lg: 3 cols, md: 4 cols, sm: 6 cols, xs: 12 cols) */
  .gallery-cell { grid-column: span 3; }
  @media (max-width: 1200px){ .gallery-cell { grid-column: span 4; } }
  @media (max-width: 992px){  .gallery-cell { grid-column: span 6; } }
  @media (max-width: 576px){  .gallery-cell { grid-column: 1 / -1; } }

  .gallery-card.card {
    width: 100%;
    border: 1px solid rgba(0,0,0,.05);
    box-shadow: 0 1px 8px rgba(0,0,0,.05);
    transition: transform .15s ease, box-shadow .15s ease, opacity .15s ease;
  }
  .gallery-card.card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,.08); }
  .gallery-card.busy { opacity: .6; pointer-events: none; }

  /* Thumb: short for reduced card height (your request) */
  .gallery-thumb {
    height: 150px;
    width: 100%;
    object-fit: cover;
    border-top-left-radius: .5rem;
    border-top-right-radius: .5rem;
    background: #f6f9fc;
  }

  .gallery-card .card-body { padding: .5rem .75rem; }

  .tag-badge {
    position: absolute; top: .5rem; left: .5rem;
    padding: .25rem .45rem;
    background: rgba(255,255,255,.9);
    border-radius: .35rem; font-size: .75rem; font-weight: 600;
    border: 1px solid rgba(0,0,0,.08);
  }
  .tag-badge[data-tag="SC1"] { color: #0d6efd; border-color: rgba(13,110,253,.35); }
  .tag-badge[data-tag="SC2"] { color: #198754; border-color: rgba(25,135,84,.35); }

  .actions .btn { padding: .2rem .5rem; font-size: .75rem; }
  .actions .dropdown-item { font-size: .85rem; }

  /* Upload bar / dropzone */
  .dropzone {
    border: 1px dashed #ced4da; border-radius: .5rem; padding: .75rem;
    background: #fbfdff; display: flex; align-items: center; gap: .5rem; flex-wrap: wrap;
  }
  .dropzone.dragover { background: #eef6ff; border-color: #86b7fe; }

  /* Fallback so dropdown still shows if bootstrap js missing */
  .dropdown-menu.show { display: block; }
</style>

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-xl-10 col-lg-11 mx-auto">

      <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">{% if object and object.pk %}Edit Technology{% else %}Add Technology{% endif %}</h4>
            <small class="text-muted">
              {% if object and object.pk %}Update details for <strong>{{ object.name }}</strong>{% else %}Create a new technology entry{% endif %}
            </small>
          </div>
          {% if object and object.pk %}
            <a href="{{ object.get_absolute_url }}" class="btn btn-sm btn-outline-primary">View</a>
          {% endif %}
        </div>

        {# OUTER FORM: only main model fields submit here #}
        <form method="post" action="" enctype="multipart/form-data" novalidate>
          {% csrf_token %}

          <div class="card-body">
            {% if form.non_field_errors %}
              <div class="alert alert-warning mb-3">{{ form.non_field_errors }}</div>
            {% endif %}

            <!-- Top row -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Technology Name <span class="text-danger">*</span></label>
                {{ form.name }}
                {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Short Description</label>
                {{ form.description }}
              </div>
            </div>

            <!-- Classification -->
            <div class="mt-4">
              <h6 class="text-uppercase text-muted mb-2">Classification</h6>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Macro Level</label>
                  <select id="macro-select" name="macro" class="form-control"
                          data-initial="{{ form.macro.value|default_if_none:''|escape }}">
                    <option value="">Loading…</option>
                  </select>
                  <div id="new-macro-wrap" class="mt-2" style="display:none;">
                    <input type="text" class="form-control" name="new_macro" placeholder="New Macro"
                           value="{{ form.new_macro.value|default_if_none:'' }}">
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Meso Level 1</label>
                  <select id="meso1-select" name="meso1" class="form-control"
                          data-initial="{{ form.meso1.value|default_if_none:''|escape }}">
                    <option value="">Select Macro first</option>
                  </select>
                  <div id="new-meso1-wrap" class="mt-2" style="display:none;">
                    <input type="text" class="form-control" name="new_meso1" placeholder="New Meso1"
                           value="{{ form.new_meso1.value|default_if_none:'' }}">
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Meso Level 2 (optional)</label>
                  <select id="meso2-select" name="meso2" class="form-control"
                          data-initial="{{ form.meso2.value|default_if_none:''|escape }}">
                    <option value="">Select Meso1 first</option>
                  </select>
                  <div id="new-meso2-wrap" class="mt-2" style="display:none;">
                    <input type="text" class="form-control" name="new_meso2" placeholder="New Meso2"
                           value="{{ form.new_meso2.value|default_if_none:'' }}">
                  </div>
                </div>
              </div>
            </div>

            <!-- Meta -->
            <div class="row g-3 mt-4">
              <div class="col-md-6">
                <label class="form-label">Confidentiality</label>
                {{ form.confidentiality }}
              </div>
              <div class="col-md-6">
                <label class="form-label d-block">Status</label>
                <div class="form-check form-switch">
                  {{ form.is_active }}
                  <label class="form-check-label ms-2" for="{{ form.is_active.id_for_label }}">Active</label>
                </div>
              </div>
            </div>

            {% if object and object.pk %}
              <hr class="my-4">
              <h6 class="text-uppercase text-muted mb-3">Content</h6>

              <!-- Long sections – TinyMCE bullets + hints -->
              <div class="mb-3">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Descriptions & Applications</span>
                  <span class="badge bg-info text-dark">Hint</span>
                </label>
                <div class="small text-muted">
                  <p>Some pertinent details about the disruptive technology. State the applications. Cite and describe a baseline application. Declare a reference technology this one can be compared against.</p>
                </div>
                {{ form.desc_and_applications }}
                <small class="text-muted" data-counter-for="editor-desc">0 / 960</small>
              </div>

              <div class="mb-3">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Publications & Projects</span>
                  <span class="badge bg-info text-dark">Hint</span>
                </label>
                <div class="small text-muted">
                  <p>Provide information about SAFRAN FdR item, survey of external publications, patents, funded projects.</p>
                </div>
                {{ form.publications_and_projects }}
                <small class="text-muted" data-counter-for="editor-pub">0 / 700</small>
              </div>

              <div class="mb-3">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Attributes & Performance</span>
                  <span class="badge bg-info text-dark">Hint</span>
                </label>
                <div class="small text-muted">
                  <p>Some details that further describe the said technology. Review of performance outcomes in line with current sensibilities.</p>
                </div>
                {{ form.attributes_and_performance }}
                <small class="text-muted" data-counter-for="editor-attr">0 / 700</small>
              </div>

              <div class="mb-3">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Strategic Value & Evaluation</span>
                  <span class="badge bg-info text-dark">Hint</span>
                </label>
                <div class="small text-muted">
                  <p>Text that highlights any strategic value of said technology. Provide text that analyses the evaluation chart.</p>
                </div>
                {{ form.strategic_value_and_evaluation }}
                <small class="text-muted" data-counter-for="editor-strat">0 / 700</small>
              </div>

              <div class="mb-3">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Enabling Technologies</span>
                  <span class="badge bg-info text-dark">Hint</span>
                </label>
                <div class="small text-muted">
                  <p>A brief review of the enabling technologies that are key to said technology.</p>
                </div>
                {{ form.enabling_technologies }}
                <small class="text-muted" data-counter-for="editor-enab">0 / 680</small>
              </div>

              <div class="mb-4">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Challenges & Current Status</span>
                  <span class="badge bg-info text-dark">Hint</span>
                </label>
                <div class="small text-muted">
                  <p>Indicate the status of said technology, including TRL/SRL rating. If applicable, cite any reasons as to why it has been dormant. Highlight the challenges that need to be surmounted, and discuss risk amelioration strategies.</p>
                </div>
                {{ form.challenges_and_current_status }}
                <small class="text-muted" data-counter-for="editor-chal">0 / 960</small>
              </div>

              <!-- Additional Fields -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-uppercase text-muted mb-0">Additional Fields</h6>
                <button class="btn btn-sm btn-outline-primary" type="button" id="toggle-add-field">Add New Field</button>
              </div>

              {# Add field (AJAX, no nested form) #}
              <div id="add-field-form"
                   class="border rounded p-3 mb-4"
                   style="display:none;"
                   data-add-url="{% url 'technology_add_field' object.pk %}">
                <div class="row g-2">
                  <div class="col-md-4">
                    <input type="text" class="form-control" name="field_name" placeholder="Field name" required>
                  </div>
                  <div class="col-12 mt-2">
                    <textarea class="form-control tinymce-extra" name="field_content" rows="4" placeholder="Enter bullet points"></textarea>
                  </div>
                </div>
                <div class="mt-2 text-end">
                  <button class="btn btn-primary btn-sm" type="button" id="btn-add-field">Save Field</button>
                </div>
              </div>

              {% if extra_fields %}
                <div class="row">
                  {% for f in extra_fields %}
                    <div class="col-md-6">
                      <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                          <strong>{{ f.name }}</strong>
                          <button
                            class="btn btn-sm btn-outline-danger js-delete-field"
                            type="button"
                            data-url="{% url 'technology_delete_field' object.pk forloop.counter0 %}">
                            Delete
                          </button>
                        </div>
                        <div class="mt-2">
                          {{ f.content|safe }}
                        </div>
                        <details class="mt-2">
                          <summary class="text-muted small">Edit</summary>
                          <textarea
                            class="form-control tinymce-extra js-edit-text"
                            name="field_content"
                            rows="4">{{ f.content }}</textarea>
                          <div class="mt-2 text-end">
                            <button
                              class="btn btn-sm btn-primary js-save-field"
                              type="button"
                              data-url="{% url 'technology_edit_field' object.pk forloop.counter0 %}">
                              Save
                            </button>
                          </div>
                        </details>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              <!-- ====== Gallery ====== -->
              <hr class="my-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-uppercase text-muted mb-0">Gallery</h6>
                <div class="gallery-toolbar d-flex">
                  <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle-gallery">Hide</button>
                </div>
              </div>

              <div id="gallery-box" class="mt-2" >
                <!-- Upload/Dropzone -->
                <div class="dropzone mb-3" id="upload-bar" data-upload-url="{% url 'technology_gallery_add' object.pk %}">
                  <input id="gallery-upload-file" type="file" accept="image/*" class="form-control" style="max-width:320px">
                  <select id="gallery-upload-tag" class="form-select" style="max-width:120px;">
                    <option value="">-- Tag --</option>
                    <option value="SC1">SC1</option>
                    <option value="SC2">SC2</option>
                  </select>
                  <button id="btn-gallery-upload" class="btn btn-success btn-sm" type="button">Upload</button>
                  <span class="text-muted small ms-2">Tip: drag & drop an image onto this bar.</span>
                </div>

                <!-- Grid -->
                <div class="gallery-grid">
                  {% for img in gallery %}
                    <div class="gallery-cell">
                      <div
                        class="card gallery-card position-relative"
                        data-image="{{ img.name }}"
                        data-url-update="{% url 'technology_gallery_update_tag' object.pk %}"
                        data-url-delete="{% url 'technology_gallery_delete' object.pk %}"
                      >
                        {% if img.tag %}
                          <span class="tag-badge" data-tag="{{ img.tag }}">{{ img.tag }}</span>
                        {% endif %}

                        <img
                          loading="lazy"
                          class="card-img-top gallery-thumb"
                          src="{% if img.b64 %}{{ img.b64 }}{% elif img.image_path %}{{ MEDIA_URL }}{{ img.image_path }}{% endif %}"
                          alt="{{ img.name|default:'Image' }}"
                          title="{{ img.name|default:'Image' }}"
                        >

                        <div class="card-body">
                          <div class="d-flex align-items-center justify-content-between actions">
                            <!-- Argon/Bootstrap dropdown tagger (per-card) -->
                            <div class="btn-group">
                              <button type="button" class="btn btn-sm btn-white dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="ni ni-tag me-1"></i> Tag
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item js-quick-tag" type="button" data-tag="SC1">Tag as SC1</button></li>
                                <li><button class="dropdown-item js-quick-tag" type="button" data-tag="SC2">Tag as SC2</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item js-quick-tag" type="button" data-tag="">Clear tag</button></li>
                              </ul>
                            </div>

                            <button class="btn btn-sm btn-outline-danger js-del-image" type="button">
                              <i class="ni ni-fat-remove me-1"></i> Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% empty %}
                    <div class="col-12 text-muted small">No images uploaded yet.</div>
                  {% endfor %}
                </div>
              </div>
              <!-- /Gallery -->
            {% endif %}
          </div>

          <div class="card-footer d-flex justify-content-between">
            <a href="{% url 'technology_list' %}" class="btn btn-outline-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">
              {% if object and object.pk %}Save Changes{% else %}Create Technology{% endif %}
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

{# --- Small Modals (feedback + confirm) --- #}
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body py-3">
        <div id="feedbackIcon" class="text-center mb-2"></div>
        <div id="feedbackText" class="text-center small"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">Confirm</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-3">
        <p id="confirmText" class="mb-0 small">Are you sure?</p>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-sm btn-danger" id="confirmOkBtn">Yes</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
{# Bootstrap bundle (Popper included). Adjust path if needed or remove if already in base.html #}

{# Local TinyMCE #}
<script src="{% static 'tinymce/tinymce.min.js' %}"></script>

<script>
/* ======= Helpers: small feedback + confirm modals ======= */
(function(){
  window.showFeedback = function(message, kind='info', opts={}) {
    const iconWrap = document.getElementById('feedbackIcon');
    const text = document.getElementById('feedbackText');
    if (!iconWrap || !text) return;

    const icons = {
      success: '<span class="badge bg-success">Success</span>',
      danger:  '<span class="badge bg-danger">Error</span>',
      warning: '<span class="badge bg-warning text-dark">Warning</span>',
      info:    '<span class="badge bg-info text-dark">Info</span>',
    };
    iconWrap.innerHTML = icons[kind] || icons.info;
    text.textContent = message || '';

    const el = document.getElementById('feedbackModal');
    if (!el) return;
    let modal;
    if (window.bootstrap?.Modal) {
      modal = bootstrap.Modal.getOrCreateInstance(el, { backdrop: 'static', keyboard: false });
      modal.show();
      setTimeout(()=> modal.hide(), opts.autoHideMs || 1100);
    } else {
      el.classList.add('show'); el.style.display = 'block'; // light fallback
      setTimeout(()=> { el.classList.remove('show'); el.style.display = 'none'; }, opts.autoHideMs || 1100);
    }
    if (opts.onHide) {
      el.addEventListener('hidden.bs.modal', function handler(){ el.removeEventListener('hidden.bs.modal', handler); opts.onHide(); });
      // fallback: call anyway after timeout
      setTimeout(()=> { try { opts.onHide(); } catch(e){} }, (opts.autoHideMs || 1100)+50);
    }
  };

  window.confirmModal = function(message='Are you sure?') {
    return new Promise(resolve => {
      const text = document.getElementById('confirmText');
      const ok   = document.getElementById('confirmOkBtn');
      const el   = document.getElementById('confirmModal');
      if (text) text.textContent = message;

      let decided = false;
      function cleanup(){
        ok.removeEventListener('click', onOk);
        el.removeEventListener('hidden.bs.modal', onHide);
      }
      function onOk(){
        decided = true; cleanup(); if (window.bootstrap?.Modal) bootstrap.Modal.getInstance(el)?.hide();
        resolve(true);
      }
      function onHide(){
        cleanup(); if (!decided) resolve(false);
      }
      ok.addEventListener('click', onOk);
      el.addEventListener('hidden.bs.modal', onHide);

      if (window.bootstrap?.Modal) bootstrap.Modal.getOrCreateInstance(el).show();
      else { el.classList.add('show'); el.style.display = 'block'; } // very light fallback
    });
  };
})();
</script>

<script>
/* ======= Taxonomy + TinyMCE ======= */
(function(){
  const URL_MACROS = "/technology/api/macros/";
  const URL_MESO1  = (macro) => `/technology/api/meso1/${encodeURIComponent(macro)}/`;
  const URL_MESO2  = (m1)    => `/technology/api/meso2/${encodeURIComponent(m1)}/`;

  const $macro = $("#macro-select"), $meso1 = $("#meso1-select"), $meso2 = $("#meso2-select");
  const initMacro = document.getElementById('macro-select').dataset.initial || "";
  const initM1    = document.getElementById('meso1-select').dataset.initial || "";
  const initM2    = document.getElementById('meso2-select').dataset.initial || "";
  const $newMac = $("#new-macro-wrap"), $newM1 = $("#new-meso1-wrap"), $newM2 = $("#new-meso2-wrap");

  function opt(t,v){return $('<option>').text(t).val(v);}
  function ensureSelected($s, v){
    if (!v) { $s.val(""); return; }
    const exists = $s.find('option').filter(function(){ return $(this).val() === v; }).length > 0;
    if (!exists) { $s.prepend(opt(v, v)); }
    $s.val(v);
  }

  function toggleNewInputs(){ const m=$macro.val(), m1=$meso1.val(), m2=$meso2.val(); $newMac.toggle(m==="__new__"); $newM1.toggle(m==="__new__"||m1==="__new__"); $newM2.toggle(m==="__new__"||m1==="__new__"||m2==="__new__"); }

  function loadMacros(){
    $macro.empty().append(opt("Select Macro",""));
    $.getJSON(URL_MACROS).done(d=>{(d||[]).forEach(it=>$macro.append(opt(it.name,it.name))); $macro.append(opt("+ Add new","__new__"));})
      .always(()=>{ensureSelected($macro,initMacro); toggleNewInputs(); handleMacroChange(true);});
  }
  function handleMacroChange(isInit){
    const val=$macro.val();
    $meso1.empty().append(opt(val==="__new__"?"+ Add new":"Select Meso1",""));
    $meso2.empty().append(opt("Select Meso2",""));
    if(val && val!=="__new__"){
      $.getJSON(URL_MESO1(val)).done(d=>{(d||[]).forEach(it=>$meso1.append(opt(it.name,it.name))); $meso1.append(opt("+ Add new","__new__"));})
        .always(()=>{ if(isInit) ensureSelected($meso1,initM1); toggleNewInputs(); handleMeso1Change(true); });
    }else{
      $meso1.append(opt("+ Add new","__new__")); $meso2.append(opt("+ Add new","__new__")); toggleNewInputs();
    }
  }
  function handleMeso1Change(isInit){
    const val=$meso1.val();
    $meso2.empty().append(opt(val==="__new__"?"+ Add new":"Select Meso2",""));
    if(val && val!=="__new__"){
      $.getJSON(URL_MESO2(val)).done(d=>{(d||[]).forEach(it=>$meso2.append(opt(it.name,it.name))); $meso2.append(opt("+ Add new","__new__"));})
        .always(()=>{ if(isInit) ensureSelected($meso2,initM2); toggleNewInputs(); });
    }else{ $meso2.append(opt("+ Add new","__new__")); toggleNewInputs(); }
  }
  $macro.on("change",()=>handleMacroChange(false));
  $meso1.on("change",()=>handleMeso1Change(false));
  $meso2.on("change", () => toggleNewInputs());
  loadMacros();

  // Assign stable IDs for counters
  function ensureEditorId(fieldName, editorId){
    const $el = $(`textarea[name="${fieldName}"]`);
    if ($el.length){ $el.attr('id', editorId).addClass('tinymce-bullets'); }
  }
  ensureEditorId("desc_and_applications", "editor-desc");
  ensureEditorId("publications_and_projects", "editor-pub");
  ensureEditorId("attributes_and_performance", "editor-attr");
  ensureEditorId("strategic_value_and_evaluation", "editor-strat");
  ensureEditorId("enabling_technologies", "editor-enab");
  ensureEditorId("challenges_and_current_status", "editor-chal");

  // TinyMCE bullets with counters
  const LIMITS = { "editor-desc":960, "editor-pub":700, "editor-attr":700, "editor-strat":700, "editor-enab":680, "editor-chal":960 };
  function updateCount(editorId, max){
    const ed = window.tinymce && tinymce.get(editorId);
    if(!ed) return;
    const text = ed.getContent({format:'text'}) || '';
    const n = text.length;
    const $counter = $(`[data-counter-for="${editorId}"]`);
    if($counter.length){ $counter.text(`${n} / ${max} characters`).css('color', n>max ? 'red' : '#6c757d'); }
  }
  tinymce.init({
    selector: 'textarea.tinymce-bullets, textarea.tinymce-extra',
    menubar: false, branding: false,
    plugins: 'lists charmap',
    toolbar: 'bold italic subscript superscript charmap',
    forced_root_block: 'p', paste_as_text: true,
    valid_elements: 'ul,li,strong,em,sup,sub,span',
    invalid_elements: 'p,h1,h2,h3,h4,h5,h6,img,table,div',
    setup: function (ed) {
      function ensureBullets(){
        const body = ed.getBody();
        const ul = body && body.querySelector && body.querySelector('ul');
        if (!ul){ ed.setContent('<ul><li></li></ul>'); const li = ed.getBody().querySelector('li'); if (li) ed.selection.setCursorLocation(li, 0); }
      }
      $('form').on('submit', function(){ tinymce.triggerSave(); });
      ed.on('init', function(){
        ensureBullets();
        const id = ed.getElement().id, lim = LIMITS[id];
        if(lim){ updateCount(id, lim); }
      });
      ed.on('input change paste keyup', function(){
        const id = ed.getElement().id, lim = LIMITS[id];
        if(lim){ updateCount(id, lim); }
      });
      ed.on('keydown', function(e){
        const node = ed.selection.getNode();
        if (e.key === 'Enter' && node && node.nodeName === 'LI' && node.innerText.trim() === ''){ e.preventDefault(); }
        if (e.key === 'Backspace'){
          const lis = ed.getBody().querySelectorAll('li');
          if (lis.length === 1 && lis[0].innerText.trim() === ''){ e.preventDefault(); }
        }
      });
      ed.on('input change paste', function(){ setTimeout(ensureBullets, 10); });
    }
  });

  // Show/Hide gallery
  $("#toggle-gallery").on("click", function(){
    const box = $("#gallery-box"); box.toggle();
    $(this).text(box.is(":visible") ? "Hide" : "Show");
  });
})();
</script>

<script>
/* ======= AJAX for extra fields + gallery (scoped per-card) ======= */
(function () {
  function csrfValue() {
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
  }
  function saveEditors() {
    if (window.tinymce && tinymce.triggerSave) tinymce.triggerSave();
  }
  function postFD(url, fd) {
    return fetch(url, {
      method: 'POST',
      body: fd,
      credentials: 'same-origin',
      headers: { 'X-CSRFToken': csrfValue() }
    }).then(r => { if (!r.ok) throw new Error('Request failed'); return r.text(); });
  }
  function setBusy(el, on){ if (!el) return; el.classList.toggle('busy', !!on); }

  /* ---- Extra fields ---- */
  $('#toggle-add-field').on('click', ()=> $('#add-field-form').toggle());
  $('#btn-add-field').on('click', function () {
    saveEditors();
    const wrap = document.getElementById('add-field-form');
    if (!wrap) return;
    const url = wrap.dataset.addUrl;
    const name = (wrap.querySelector('input[name="field_name"]').value || '').trim();
    const content = wrap.querySelector('textarea[name="field_content"]').value || '';
    if (!name) {
      showFeedback('Please enter a field name.', 'warning');
      wrap.querySelector('input[name="field_name"]').focus();
      return;
    }

    const fd = new FormData();
    fd.append('field_name', name);
    fd.append('field_content', content);
    fd.append('csrfmiddlewaretoken', csrfValue());

    postFD(url, fd)
      .then(() => showFeedback('Field added.', 'success', { onHide: ()=> location.reload() }))
      .catch(() => showFeedback('Could not add field.', 'danger'));
  });
  $(document).on('click', '.js-save-field', function () {
    saveEditors();
    const url = this.dataset.url;
    const ta = $(this).closest('details').find('textarea[name="field_content"]')[0];
    const content = ta ? ta.value : '';
    const fd = new FormData();
    fd.append('field_content', content);
    fd.append('csrfmiddlewaretoken', csrfValue());
    postFD(url, fd)
      .then(() => showFeedback('Field saved.', 'success', { onHide: ()=> location.reload() }))
      .catch(() => showFeedback('Could not save field.', 'danger'));
  });
  $(document).on('click', '.js-delete-field', async function () {
    const url = this.dataset.url;
    const yes = await confirmModal('Delete this field?');
    if (!yes) return;
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrfValue());
    postFD(url, fd)
      .then(() => showFeedback('Field deleted.', 'success', { onHide: ()=> location.reload() }))
      .catch(() => showFeedback('Could not delete field.', 'danger'));
  });

  /* ---- Gallery upload (drag & drop + button) ---- */
  const dz = document.getElementById('upload-bar');
  if (dz) {
    const fileInput = document.getElementById('gallery-upload-file');
    const tagSelect = document.getElementById('gallery-upload-tag');

    function doUpload(file) {
      const url = dz.getAttribute('data-upload-url');
      const fd = new FormData();
      fd.append('image', file);
      fd.append('tag', tagSelect.value || '');
      fd.append('csrfmiddlewaretoken', csrfValue());
      setBusy(dz, true);
      postFD(url, fd)
        .then(() => showFeedback('Image uploaded.', 'success', { onHide: ()=> location.reload() }))
        .catch(() => showFeedback('Upload failed.', 'danger'))
        .finally(() => setBusy(dz, false));
    }

    $('#btn-gallery-upload').on('click', function(){
      const f = fileInput.files[0];
      if (!f) { showFeedback('Choose an image first.', 'warning'); return; }
      doUpload(f);
    });
    ;['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover'); }));
    dz.addEventListener('drop', e => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) doUpload(f);
    });
  }

  /* ---- Gallery quick tag + delete (PER-CARD scope) ---- */
  // Tag via dropdown menu (in-place update, no full page reload)
  $(document).on('click', '.js-quick-tag', function () {
    const card = this.closest('.gallery-card');
    if (!card) return;
    const name = card.dataset.image;
    const url  = card.dataset.urlUpdate;
    const newTag  = this.dataset.tag || '';

    const fd = new FormData();
    fd.append('image_name', name);
    fd.append('tag', newTag);
    fd.append('csrfmiddlewaretoken', csrfValue());

    setBusy(card, true);
    postFD(url, fd)
      .then(() => {
        // enforce uniqueness visually: if tagging SC1/SC2, clear same badge on other cards
        if (newTag === 'SC1' || newTag === 'SC2') {
          document.querySelectorAll('.gallery-card .tag-badge').forEach(b => {
            if (b.closest('.gallery-card') !== card && b.dataset.tag === newTag) b.remove();
          });
        }
        // update current card badge
        let badge = card.querySelector('.tag-badge');
        if (newTag) {
          if (!badge) {
            badge = document.createElement('span');
            badge.className = 'tag-badge';
            card.appendChild(badge);
          }
          badge.dataset.tag = newTag;
          badge.textContent = newTag;
        } else if (badge) {
          badge.remove();
        }

        // close dropdown
        const toggleBtn = card.querySelector('[data-bs-toggle="dropdown"]');
        if (window.bootstrap?.Dropdown && toggleBtn) {
          bootstrap.Dropdown.getOrCreateInstance(toggleBtn).hide();
        } else {
          const menu = this.closest('.dropdown-menu'); if (menu) menu.classList.remove('show');
        }
        showFeedback('Tag updated.', 'success');
      })
      .catch(() => showFeedback('Could not update tag.', 'danger'))
      .finally(() => setBusy(card, false));
  });

  // Delete per-card with confirm modal (no full reload)
  $(document).on('click', '.js-del-image', async function () {
    const card = this.closest('.gallery-card');
    if (!card) return;
    const yes = await confirmModal('Delete this image?');
    if (!yes) return;

    const name = card.dataset.image;
    const url  = card.dataset.urlDelete;

    const fd = new FormData();
    fd.append('image_name', name);
    fd.append('csrfmiddlewaretoken', csrfValue());

    setBusy(card, true);
    postFD(url, fd)
      .then(() => { card.remove(); showFeedback('Image deleted.', 'success'); })
      .catch(() => { setBusy(card, false); showFeedback('Could not delete image.', 'danger'); });
  });

  /* ---- Dropdown fallback if Bootstrap JS absent ---- */
  if (!window.bootstrap) {
    document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(btn => {
      btn.addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        const menu = this.nextElementSibling;
        if (!menu || !menu.classList.contains('dropdown-menu')) return;
        const actions = this.closest('.actions');
        if (actions) actions.querySelectorAll('.dropdown-menu.show').forEach(m => { if (m !== menu) m.classList.remove('show'); });
        menu.classList.toggle('show');
      });
    });
    document.addEventListener('click', function(){
      document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
    });
  }
})();
</script>
{% endblock %}
