{% extends 'layouts/base.html' %}
{% block title %} Profile {% endblock title %}

{% block content %}
{% load static %}

{# ---------- TOASTS ---------- #}
<div aria-live="polite" aria-atomic="true" class="position-fixed" style="right: 1rem; bottom: 1rem; z-index: 1080;">
  <div id="toast-stack" class="d-flex flex-column gap-2"></div>
</div>

{# ---------- HEADER (black) ---------- #}
<div class="header bg-darker pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col">
          <h6 class="h2 text-white d-inline-block mb-0">Hello, {{ u.full_name|default:u.username }}</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links mb-0 crumb-light">
              <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i></a></li>
              <li class="breadcrumb-item active" aria-current="page">Profile</li>
            </ol>
          </nav>
        </div>
        <div class="col-auto text-right">
          {% if can_edit %}
            <button type="button" id="btn-edit" class="btn btn-outline-light btn-sm">Edit profile</button>
            <button type="submit" id="btn-save" class="btn btn-light btn-sm" form="profile-form">Save changes</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{# ---------- MAIN ---------- #}
<div class="container-fluid mt--6">
  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-9">

      <div class="card profile-card shadow-sm card-glass">
        {# Banner / cover #}
        <div class="profile-cover">
          <div class="cover-overlay"></div>
        </div>

        <div class="card-body p-4 p-md-5">
          <form id="profile-form" method="post" action="" enctype="multipart/form-data">
            {% csrf_token %}

            {# AVATAR + NAME #}
            <div class="d-flex flex-column align-items-center text-center">
              <div class="profile-avatar">
                <img
                  id="avatarPreview"
                  src="{% url 'profile_avatar' u.pk %}{% if u.avatar_sha1 %}?v={{ u.avatar_sha1 }}{% endif %}"
                  class="rounded-circle avatar-xxl"
                  alt="Avatar">
              </div>

              <h2 class="profile-name mb-1 mt-2">{{ u.full_name|default:u.username }}</h2>
              <div class="text-muted">{{ u.email|default:'' }}</div>
            </div>

            <hr class="section-divider">

            {# USER INFO (single column) #}
            <h6 class="section-title mb-3">User information</h6>

            <div class="form-group">
              <label class="form-control-label">Username</label>
              <input type="text" class="form-control" value="{{ u.username }}" readonly>
            </div>

            <div class="form-group">
              <label class="form-control-label">Email</label>
              <input type="email" class="form-control" value="{{ u.email|default:'' }}" readonly>
            </div>

            <div class="form-group">
              <label class="form-control-label" for="input-full-name">Full name</label>
              <input type="text" name="full_name" id="input-full-name" class="form-control"
                     value="{{ u.full_name|default:'' }}" data-editable="1" disabled>
            </div>

            <div class="form-group">
              <label class="form-control-label" for="input-phone">Phone</label>
              <input type="text" name="phone_number" id="input-phone" class="form-control"
                     value="{{ u.phone_number|default:'' }}" data-editable="1" disabled>
            </div>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label class="form-control-label" for="input-dob">Date of Birth</label>
                <input type="date" name="date_of_birth" id="input-dob" class="form-control"
                       value="{{ u.date_of_birth|date:'Y-m-d' }}" data-editable="1" disabled>
              </div>
              <div class="form-group col-md-6">
                <label class="form-control-label" for="input-gender">Gender</label>
                <input type="text" name="gender" id="input-gender" class="form-control"
                       value="{{ u.gender|default:'' }}" data-editable="1" disabled>
              </div>
            </div>

            {# ===== Avatar editor moved DOWN here ===== #}
            {% if can_edit %}
            <hr class="section-divider">
            <h6 class="section-title mb-3">Change avatar</h6>

            <div id="avatar-edit-section">
              <div id="avatar-upload-group" class="custom-file d-none" style="max-width:420px;">
                <input
                  type="file"
                  class="custom-file-input"
                  id="input-avatar"
                  name="avatar_file"
                  accept=".jpg,.jpeg,.png,.webp"
                  data-editable="1">
                <label class="custom-file-label text-truncate" id="input-avatar-label" for="input-avatar">Choose file</label>
              </div>
              <div id="avatar-actions" class="mt-2 d-none">
                <button type="button" class="btn btn-sm btn-dark" id="btn-avatar-confirm">Use this photo</button>
                <button type="button" class="btn btn-sm btn-outline-dark" id="btn-avatar-clear">Clear</button>
                <span id="avatar-ready" class="badge badge-success ml-2 d-none">Ready to save</span>
              </div>
              <input type="hidden" name="avatar_confirmed" id="avatar_confirmed" value="0">
            </div>
            {% endif %}

            <hr class="section-divider">

            {# ADDRESS #}
            <h6 class="section-title mb-3">Contact information</h6>

            <div class="form-group">
              <label class="form-control-label" for="input-address1">Address line 1</label>
              <input id="input-address1" name="address_line1" class="form-control" type="text"
                     value="{{ u.address_line1|default:'' }}" data-editable="1" disabled>
            </div>

            <div class="form-group">
              <label class="form-control-label" for="input-address2">Address line 2</label>
              <input id="input-address2" name="address_line2" class="form-control" type="text"
                     value="{{ u.address_line2|default:'' }}" data-editable="1" disabled>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label class="form-control-label" for="input-city">City</label>
                <input type="text" name="city" id="input-city" class="form-control"
                       value="{{ u.city|default:'' }}" data-editable="1" disabled>
              </div>
              <div class="form-group col-md-4">
                <label class="form-control-label" for="input-country">Country</label>
                <input type="text" name="country" id="input-country" class="form-control"
                       value="{{ u.country|default:'' }}" data-editable="1" disabled>
              </div>
              <div class="form-group col-md-4">
                <label class="form-control-label" for="input-postal-code">Postal code</label>
                <input type="text" name="postcode" id="input-postal-code" class="form-control"
                       value="{{ u.postcode|default:'' }}" data-editable="1" disabled>
              </div>
            </div>

            <hr class="section-divider">

            {# ROLE #}
            <h6 class="section-title mb-3">Role</h6>
            <div class="mb-2">
              <span class="badge badge-info">{{ u.role.name|default:'â€”' }}</span>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  {% include "includes/footer.html" %}
</div>
{% endblock content %}

{% block stylesheets %}
{{ block.super }}
<style>
  /* Breadcrumb chip (dark text on white chip over black header) */
  .header.bg-darker .crumb-light{
    background:#fff; padding:.35rem .75rem; border-radius:.5rem; display:inline-flex;
  }
  .header.bg-darker .crumb-light .breadcrumb-item,
  .header.bg-darker .crumb-light .breadcrumb-item a,
  .header.bg-darker .crumb-light .breadcrumb-item i{ color:#111 !important; }
  .header.bg-darker .crumb-light .breadcrumb-item + .breadcrumb-item::before{ color:#111 !important; opacity:.85; }

  /* Card & banner */
  .card-glass{
    background: rgba(255,255,255,0.88) !important;
    border: 1px solid rgba(255,255,255,0.25);
    box-shadow: 0 8px 24px rgba(0,0,0,.10);
    backdrop-filter: saturate(120%) blur(6px);
    -webkit-backdrop-filter: saturate(120%) blur(6px);
    border-radius:18px; overflow:hidden;
  }


  #panel{
    background: url("{% static 'assets/img/2.jpg' %}") center center / cover no-repeat;
    min-height: 100dvh;                 /* avoid mobile gaps */
    position: relative;                 /* for optional overlays */
  }

  @media (min-width: 992px){
    #panel{ background-attachment: fixed; }
  }

  /* If you want a subtle dark veil for readability, uncomment:
  #panel::before{
    content:"";
    position: fixed; inset: 0; pointer-events: none;
    background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.12));
  } */

  /* Keep the footer on the same background (or your black footer style) */
  .footer, footer{
    background: transparent;  /* or your .footer-dark black if you prefer */
    border-top: 0;
  }

  @media (min-width: 1200px){ .profile-cover{ height: 280px; } }
  .cover-overlay{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,0)); }

  /* Bigger avatar + better overlap */
  .profile-avatar{ margin-top: -96px; }
  .avatar-xxl{
    width: 180px; height: 180px; object-fit: cover;
    box-shadow: 0 10px 28px rgba(0,0,0,.25);
    border: 4px solid #fff; border-radius: 50%;
  }

  .profile-name{ font-weight:800; font-size:1.7rem; color:#111; }
  @media (min-width: 1200px){ .profile-name{ font-size:1.85rem; } }

  .section-title{ font-weight:700; color:#111; }
  .section-divider{ margin: 1.75rem 0; }

  /* Editable inputs highlight */
  #profile-form [data-editable="1"].border-primary{
    border-color:#212529 !important; box-shadow:0 0 0 .15rem rgba(33,37,41,.08);
  }

  /* File label truncation */
  .custom-file-label.text-truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
</style>
{% endblock stylesheets %}

{% block javascripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const canEdit = {{ can_edit|yesno:"true,false" }};
  const btnEdit = document.getElementById('btn-edit');
  const btnSave = document.getElementById('btn-save');
  const form    = document.getElementById('profile-form');
  const editables = document.querySelectorAll('#profile-form [data-editable="1"]');

  // Avatar controls
  const avatarUploadGroup = document.getElementById('avatar-upload-group');
  const avatarInput       = document.getElementById('input-avatar');
  const avatarLabel       = document.getElementById('input-avatar-label');
  const avatarActions     = document.getElementById('avatar-actions');
  const avatarConfirmBtn  = document.getElementById('btn-avatar-confirm');
  const avatarClearBtn    = document.getElementById('btn-avatar-clear');
  const avatarReadyBadge  = document.getElementById('avatar-ready');
  const avatarConfirmed   = document.getElementById('avatar_confirmed');
  const avatarPreview     = document.getElementById('avatarPreview');

  if (avatarPreview) avatarPreview.dataset.origsrc = avatarPreview.src;

  editables.forEach(el => { if (el.type !== 'file') el.dataset.orig = el.value || ''; el.disabled = true; });
  if (btnSave) btnSave.classList.add('d-none');

  function setEditMode(enabled, { reset=false } = {}) {
    editables.forEach(el => {
      if (!enabled && reset && el.type !== 'file') el.value = el.dataset.orig || '';
      el.disabled = !enabled;
      el.classList.toggle('border-primary', enabled);
    });

    // Show the editor section lower on the page (no overlap with email)
    if (avatarUploadGroup) avatarUploadGroup.classList.toggle('d-none', !enabled);
    if (!enabled) {
      if (avatarInput) avatarInput.value = '';
      if (avatarLabel) avatarLabel.textContent = 'Choose file';
      if (avatarActions) avatarActions.classList.add('d-none');
      if (avatarReadyBadge) avatarReadyBadge.classList.add('d-none');
      if (avatarConfirmed) avatarConfirmed.value = '0';
      if (avatarPreview && avatarPreview.dataset.origsrc) avatarPreview.src = avatarPreview.dataset.origsrc;
    }

    if (btnSave) btnSave.classList.toggle('d-none', !enabled);
    if (btnEdit) { btnEdit.textContent = enabled ? 'Cancel' : 'Edit profile'; btnEdit.dataset.mode = enabled ? 'edit' : 'view'; }
  }
  setEditMode(false);

  if (canEdit && btnEdit) {
    btnEdit.addEventListener('click', function () {
      const inEdit = btnEdit.dataset.mode === 'edit';
      setEditMode(!inEdit, { reset: inEdit });
      if (!inEdit) {
        const first = document.querySelector('#profile-form [data-editable="1"]:not([disabled])');
        if (first) first.focus();
      }
    });
  } else if (btnEdit) {
    btnEdit.classList.add('d-none');
  }

  if (avatarInput) {
    avatarInput.addEventListener('change', function () {
      const file = this.files && this.files[0];
      if (avatarConfirmed) avatarConfirmed.value = '0';

      if (!file) {
        if (avatarLabel) avatarLabel.textContent = 'Choose file';
        if (avatarActions) avatarActions.classList.add('d-none');
        if (avatarReadyBadge) avatarReadyBadge.classList.add('d-none');
        if (avatarPreview && avatarPreview.dataset.origsrc) avatarPreview.src = avatarPreview.dataset.origsrc;
        return;
      }

      const allowed = ['image/jpeg', 'image/png', 'image/webp'];
      const maxBytes = 5 * 1024 * 1024;

      if (!allowed.includes(file.type)) {
        alert('Unsupported file type. Please choose JPG, PNG, or WebP.');
        this.value = '';
        if (avatarLabel) avatarLabel.textContent = 'Choose file';
        if (avatarActions) avatarActions.classList.add('d-none');
        if (avatarReadyBadge) avatarReadyBadge.classList.add('d-none');
        return;
      }
      if (file.size > maxBytes) {
        alert('Avatar too large (max 5MB).');
        this.value = '';
        if (avatarLabel) avatarLabel.textContent = 'Choose file';
        if (avatarActions) avatarActions.classList.add('d-none');
        if (avatarReadyBadge) avatarReadyBadge.classList.add('d-none');
        return;
      }

      if (avatarLabel) avatarLabel.textContent = file.name;
      if (avatarActions) avatarActions.classList.remove('d-none');
      if (avatarReadyBadge) avatarReadyBadge.classList.add('d-none');

      try {
        const url = URL.createObjectURL(file);
        if (avatarPreview) avatarPreview.src = url;
        setTimeout(() => URL.revokeObjectURL(url), 30000);
      } catch (_) {}
    });
  }

  if (avatarConfirmBtn) {
    avatarConfirmBtn.addEventListener('click', function () {
      if (!avatarInput || !avatarInput.files || !avatarInput.files[0]) return;
      if (avatarConfirmed) avatarConfirmed.value = '1';
      if (avatarReadyBadge) avatarReadyBadge.classList.remove('d-none');
    });
  }

  if (avatarClearBtn) {
    avatarClearBtn.addEventListener('click', function () {
      if (avatarInput) avatarInput.value = '';
      if (avatarLabel) avatarLabel.textContent = 'Choose file';
      if (avatarActions) avatarActions.classList.add('d-none');
      if (avatarReadyBadge) avatarReadyBadge.classList.add('d-none');
      if (avatarConfirmed) avatarConfirmed.value = '0';
      if (avatarPreview && avatarPreview.dataset.origsrc) avatarPreview.src = avatarPreview.dataset.origsrc;
    });
  }

  if (form && btnSave) {
    form.addEventListener('submit', function () {
      btnSave.disabled = true;
      setTimeout(() => { btnSave.disabled = false; }, 2000);
    });
  }

  /* Toasts (if using Django messages) */
  const toastsData = [
    {% for message in messages %}
      { text: {{ message|escapejs }}, level: "{{ message.tags|default:'info' }}" }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  const toastStack = document.getElementById('toast-stack');
  if (toastStack && toastsData.length) {
    toastsData.forEach(({text, level}) => {
      const bg = (level.includes('success')) ? 'bg-success'
               : (level.includes('error') || level.includes('danger')) ? 'bg-danger'
               : (level.includes('warning')) ? 'bg-warning'
               : 'bg-info';
      const toast = document.createElement('div');
      toast.className = `toast text-white ${bg}`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.setAttribute('data-delay', '3000');
      toast.innerHTML = `
        <div class="toast-body d-flex align-items-center">
          <span class="mr-2">${text}</span>
          <button type="button" class="ml-auto close text-white" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>`;
      document.getElementById('toast-stack').appendChild(toast);
      $(toast).toast('show');
    });
  }
});
</script>
{% endblock javascripts %}
